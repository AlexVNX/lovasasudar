<!doctype html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RLQ6Y55SNC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXXXXXXXXX', {
    anonymize_ip: true
  });
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Calcula el castigo cal√≥rico de tu cena/noche de copas y genera un meme para compartir." />
  <meta name="theme-color" content="#0b0f2a" />

  <!-- Favicon (pon favicon.png en la misma carpeta que este HTML) -->
  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon-48.png" sizes="48x48" />
  <link rel="apple-touch-icon" href="lovasasudar-favicon-512.png" />

  <title>LoVasASudar.com ‚Äì Calculadora de castigo cal√≥rico</title>

  <!-- (Opcional) GA4: pega aqu√≠ tu snippet completo de Google Analytics si ya lo tienes -->

  <style>
    :root{
      --bg0:#05071a;
      --bg1:#080b22;
      --card:#0b1030cc;
      --card2:#070a1fcc;
      --stroke:rgba(255,255,255,.14);
      --stroke2:rgba(145,160,255,.20);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --accent:#5b7cfa;
      --pink:#ff5bcb;
      --gold:#ffd9a0;
      --good:#54ffa7;
      --bad:#ff6b6b;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(91,124,250,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(255,91,203,.18), transparent 60%),
        radial-gradient(700px 500px at 50% 105%, rgba(91,124,250,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 18px 40px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(5,8,24,.55);
      width:fit-content;
      box-shadow: var(--shadow);
      font-weight:700;
      font-size:.9rem;
      color:rgba(255,255,255,.85);
    }
    .title{
      font-size: clamp(1.6rem, 2.6vw, 2.4rem);
      font-weight: 900;
      letter-spacing:.2px;
      margin:0;
    }
    .sub{
      margin:0;
      color:var(--muted);
      max-width: 65ch;
      line-height:1.4;
    }

    .lang{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:2px;
    }
    .lang-btn{
      border:1px solid var(--stroke);
      background:rgba(5,8,24,.55);
      color:rgba(255,255,255,.82);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition:transform .08s ease, border-color .12s ease;
    }
    .lang-btn:hover{transform:translateY(-1px)}
    .lang-btn.active{
      border-color:rgba(91,124,250,.55);
      box-shadow:0 0 0 3px rgba(91,124,250,.18);
      color:rgba(255,255,255,.96);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{flex-direction:column; align-items:flex-start}
      .lang{width:100%; justify-content:flex-start}
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(11,16,48,.72), rgba(7,10,31,.62));
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      position:relative;
      overflow:hidden;
    }

    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--r) + 2px);
      background: linear-gradient(90deg, rgba(91,124,250,.18), rgba(255,91,203,.14), rgba(91,124,250,.12));
      opacity:.75;
      filter: blur(14px);
      pointer-events:none;
    }
    .card > *{position:relative}

    .card h2{
      margin:0 0 6px;
      font-size:1.25rem;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .card .subtitle{
      margin:0 0 14px;
      color:var(--muted);
      line-height:1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      font-weight:800;
      color:rgba(255,255,255,.85);
      font-size:.86rem;
    }
    .badge.kcal{
      border-color: rgba(255,217,160,.32);
      color: rgba(255,217,160,.95);
      background: rgba(25,18,5,.35);
      display:none;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }

    label{
      display:block;
      font-weight:800;
      margin:10px 0 6px;
    }
    input, select, button{
      font:inherit;
    }
    input, select{
      width:100%;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      color:rgba(255,255,255,.92);
      padding: 12px 12px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, select:focus{
      border-color: rgba(91,124,250,.55);
      box-shadow: 0 0 0 3px rgba(91,124,250,.16);
    }

    .hint{
      margin-top:6px;
      color:var(--muted2);
      font-size:.92rem;
      line-height:1.35;
    }

    .topline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      color: rgba(255,255,255,.92);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight:900;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-primary{
      border-color: rgba(91,124,250,.55);
      background: linear-gradient(90deg, rgba(91,124,250,.92), rgba(255,91,203,.82));
      color: rgba(255,255,255,.96);
      box-shadow: 0 18px 40px rgba(91,124,250,.18), 0 14px 40px rgba(255,91,203,.10);
    }
    .btn-secondary{
      border-color: rgba(159,168,255,.25);
      background: rgba(9,13,35,.62);
    }
    .btn-wide{
      width:100%;
      font-size: 1.1rem;
      letter-spacing:.5px;
      padding: 16px 16px;
      border-radius: 999px;
      margin-top:14px;
    }

    .error{
      display:none;
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(35,10,12,.55);
      color: rgba(255,180,180,.96);
      font-weight:800;
    }

    .linklike{
      color: rgba(255,255,255,.92);
      text-decoration: underline;
      text-underline-offset: 3px;
      cursor:pointer;
      font-weight:900;
    }

    /* Results */
    .results-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .phrase{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.45);
      border-radius: 18px;
      padding: 12px 12px;
      color: rgba(255,255,255,.86);
      line-height:1.35;
      margin-bottom: 12px;
    }

    .tabs{
      display:none;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 10px;
    }
    .tabs button{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.45);
      color: rgba(255,255,255,.88);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tabs button.active{
      border-color: rgba(91,124,250,.55);
      box-shadow: 0 0 0 3px rgba(91,124,250,.14);
    }
    .tabs .icon{opacity:.9}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(5,8,24,.40);
    }
    th, td{
      padding: 12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:.92rem;
      color: rgba(255,255,255,.82);
      font-weight:900;
      background: rgba(9,13,35,.45);
    }
    tr:last-child td{border-bottom:none}
    .activity-name{font-weight:900}
    .activity-soft{color:var(--muted2); font-size:.9rem; margin-top:2px}

    .meme{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    canvas{
      width:100%;
      height:auto;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.35);
    }

    .share-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .share-status{
      display:none;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(84,255,167,.25);
      background: rgba(8,30,22,.45);
      color: rgba(190,255,225,.92);
      font-weight:900;
    }

    .disclaimer{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(5,8,24,.35);
      color: rgba(255,255,255,.78);
      line-height:1.35;
      font-size:.95rem;
    }

    /* Accordions */
    details.acc{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.38);
      border-radius: 18px;
      padding: 0;
      overflow:hidden;
      margin-top: 10px;
    }
    details.acc summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 12px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(9,13,35,.45);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    details.acc summary::-webkit-details-marker{display:none}
    .acc-body{
      padding: 12px 12px 12px;
    }

    /* Food search panel */
    .panel{
      display:none;
      margin-top: 12px;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(5,8,24,.42);
      padding: 12px;
    }
    .result-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(9,13,35,.38);
      border-radius: 14px;
      padding: 10px 10px;
      margin-top:10px;
    }
    .result-item .meta{
      color: var(--muted2);
      font-size: .9rem;
      margin-top: 4px;
      line-height:1.25;
    }

    .muted{color:var(--muted2)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="pill" data-i18n="header.pill">LoVasASudar.com ¬∑ Calculadora de castigo cal√≥rico</div>
        <h1 class="title" data-i18n="header.title">LoVasASudar.com</h1>
        <p class="sub" data-i18n="header.subtitle">
          Mete lo que vas a comer y beber y descubre cu√°nto ejercicio tendr√≠as que hacer para sudarlo. Perfecta para cenas con amigos y noches de copas.
        </p>
      </div>

      <div class="lang" aria-label="Idioma">
        <button class="lang-btn active" type="button" data-lang="es">ES</button>
        <button class="lang-btn" type="button" data-lang="en">EN</button>
      </div>
    </header>

    <!-- FLUJO PRINCIPAL -->
    <div class="grid">
      <!-- PERFIL -->
      <section class="card" id="profileCard">
        <div class="topline">
          <h2>üë§ <span data-i18n="profile.title">Tu perfil</span></h2>
          <span class="badge" data-i18n="profile.badge">0% serio, 100% fiesta</span>
        </div>
        <p class="subtitle" data-i18n="profile.subtitle">Pon tus datos b√°sicos para estimar el gasto.</p>

        <label for="peso" data-i18n="profile.weightLabel">Peso (kg)</label>
        <input id="peso" type="number" min="30" max="250" step="0.1" placeholder="80" />
        <div class="hint" data-i18n="profile.weightHint">El c√°lculo se hace por kg de peso (ecuaci√≥n basada en MET).</div>

        <label for="sexo" data-i18n="profile.genderLabel">G√©nero (opcional)</label>
        <select id="sexo">
          <option value="no" data-i18n="gender.opt0">Prefiero no decirlo</option>
          <option value="hombre" data-i18n="gender.optMale">Hombre</option>
          <option value="mujer" data-i18n="gender.optFemale">Mujer</option>
          <option value="otro" data-i18n="gender.optOther">Otro</option>
        </select>
        <div class="hint" data-i18n="profile.genderHint">
          A igualdad de peso, hombres y mujeres suelen quemar algo diferente. Aqu√≠ aplicamos un ajuste sencillo (~5%) para reflejarlo de forma aproximada.
        </div>

        <div class="error" id="errorBox"></div>
      </section>

      <!-- COMIDA / BEBIDA -->
      <section class="card" id="foodCard">
        <div class="topline">
          <h2>üçî <span data-i18n="food.title">Lo que vas a tomar</span></h2>
          <span class="badge" data-i18n="food.badge">Modo noche de fiesta üåô</span>
        </div>
        <p class="subtitle" data-i18n="food.subtitle">Elige algo conocido o pon t√∫ las calor√≠as.</p>

        <label for="foodSelect" data-i18n="food.labelMain">Alimento o bebida (lista ‚Äúde culto‚Äù)</label>
        <select id="foodSelect">
          <option value="0" data-label="‚Äî">‚Äî</option>
          <optgroup label="üçï Comida">
            <option value="850" data-label="Pizza mediana">Pizza mediana (~850 kcal)</option>
            <option value="650" data-label="Hamburguesa">Hamburguesa (~650 kcal)</option>
            <option value="1050" data-label="Kebab completo">Kebab completo (~1050 kcal)</option>
            <option value="520" data-label="Raci√≥n bravas">Raci√≥n bravas (~520 kcal)</option>
            <option value="460" data-label="Bocata calamares">Bocata calamares (~460 kcal)</option>
                            <!-- McDonald's / fast food -->
                <!-- Items originales + nuevos populares 2025-2026 -->
                <option value="500" data-label="Happy Meal McDonald's">Happy Meal McDonald's (~500 kcal)</option>
                <option value="550" data-label="Big Mac">Big Mac (~550 kcal)</option>
                <option value="510" data-label="Men√∫ mediano McDonald's">Men√∫ mediano McDonald's (~510 kcal)</option>
                <option value="250" data-label="6 Nuggets McDonald's">6 Nuggets McDonald's (~250 kcal)</option>
                <option value="340" data-label="Patatas fritas medianas McDonald's">Patatas medianas McDonald's (~340 kcal)</option>
                <option value="420" data-label="Patatas gajo Burger King">Patatas gajo Burger King (~420 kcal)</option>

                <!-- Pizza / italiano (1/8 pizza mediana) -->
                <option value="450" data-label="Porci√≥n pizza queso (1/8 mediana)">Porci√≥n pizza queso (1/8 pizza mediana ~450 kcal)</option>
                <option value="500" data-label="Porci√≥n pizza pepperoni (1/8 mediana)">Porci√≥n pizza pepperoni (1/8 pizza mediana ~500 kcal)</option>
                <option value="3600" data-label="Pizza familiar queso entera">Pizza familiar queso entera (~3600 kcal aprox.)</option>
                <option value="4000" data-label="Pizza familiar pepperoni entera">Pizza familiar pepperoni entera (~4000 kcal aprox.)</option>
                <option value="600" data-label="Lasa√±a bolo√±esa">Lasa√±a bolo√±esa (~600 kcal)</option>
                <option value="700" data-label="Raci√≥n pasta carbonara">Raci√≥n pasta carbonara (~700 kcal)</option>

                <!-- Tapas / comida espa√±ola -->
                <option value="450" data-label="Porci√≥n pizza queso (1/8 mediana)">Porci√≥n pizza queso (~450 kcal)</option>
                <option value="500" data-label="Porci√≥n pizza pepperoni (1/8 mediana)">Porci√≥n pizza pepperoni (~500 kcal)</option>
                <option value="3600" data-label="Pizza familiar queso entera">Pizza familiar queso entera (~3600 kcal)</option>
                <option value="250" data-label="Pincho de tortilla">Pincho de tortilla (~250 kcal)</option>
                <option value="500" data-label="Raci√≥n patatas bravas">Raci√≥n patatas bravas (~500 kcal)</option>
                <option value="350" data-label="3 croquetas de jam√≥n">3 croquetas de jam√≥n (~350 kcal)</option>
                <option value="450" data-label="Bocadillo de jam√≥n serrano">Bocadillo de jam√≥n serrano (~450 kcal)</option>
                <option value="550" data-label="Bocadillo de calamares">Bocadillo de calamares (~550 kcal)</option>

                <!-- Dulces / boller√≠a -->
                <option value="280" data-label="Donut cl√°sico">Donut cl√°sico (~280 kcal)</option>
                <option value="220" data-label="Croissant de mantequilla">Croissant de mantequilla (~220 kcal)</option>
                <option value="400" data-label="Palmera de chocolate">Palmera de chocolate (~400 kcal)</option>
                <option value="450" data-label="Brownie de chocolate">Brownie de chocolate (~450 kcal)</option>
                <option value="450" data-label="Muffin de chocolate">Muffin de chocolate (~450 kcal)</option>
                <option value="550" data-label="Tarta de queso porci√≥n">Tarta de queso porci√≥n (~550 kcal)</option>
                <option value="500" data-label="Tarta de chocolate porci√≥n">Tarta de chocolate porci√≥n (~500 kcal)</option>

                <!-- Snacks / chocolatinas -->
                <option value="150" data-label="Barrita chocolate tipo KitKat">Barrita chocolate tipo KitKat (~150 kcal)</option>
                <option value="240" data-label="Barrita Snickers">Barrita Snickers (~240 kcal)</option>
                <option value="250" data-label="Bolsa patatas fritas peque√±a">Patatas fritas bolsa peque√±a (~250 kcal)</option>
                <option value="500" data-label="Bolsa patatas fritas grande">Patatas fritas bolsa grande (~500 kcal)</option>
                <option value="200" data-label="Kinder Bueno (2 barritas)">Kinder Bueno (2 barritas) (~200 kcal)</option>
                <option value="200" data-label="Helado de palo cremoso">Helado de palo cremoso (~200 kcal)</option>
                <option value="280" data-label="Helado tipo Magnum">Helado tipo Magnum (~280 kcal)</option>

                <!-- Otros -->
                <option value="650" data-label="Hamburguesa casera completa">Hamburguesa casera completa (~650 kcal)</option>
                <option value="350" data-label="Raci√≥n de sushi (8 piezas)">Raci√≥n de sushi (8 piezas) (~350 kcal)</option>
                <option value="300" data-label="Ensalada C√©sar completa">Ensalada C√©sar completa (~300 kcal)</option>

                <!-- Sin selecci√≥n -->
                <option value="custom" data-label="Personalizado">Otro / none</option>
                <option value="850" data-label="Kebab completo con todo">Kebab completo (~850 kcal)</option>
                <option value="950" data-label="Shawarma grande extra salsas">Shawarma grande (~950 kcal)</option>
                <option value="700" data-label="Nachos con queso y guacamole">Nachos loaded (~700 kcal)</option>
                <option value="600" data-label="10 alitas barbacoa">10 alitas barbacoa (~600 kcal)</option>
                <option value="450" data-label="Ramen tonkotsu grande">Ramen grande (~450-800 kcal)</option>
                <option value="1200" data-label="Sushi para 2 (20-24 piezas)">Sushi para 2 (~1200 kcal)</option>
                <option value="180" data-label="Sangr√≠a jarra 1L">Sangr√≠a jarra peque√±a (~180-250 kcal/vaso)</option>
                <option value="320" data-label="Cubo cerveza 6 botellines">Cubo cerveza (~320 kcal/vaso)</option>
                <option value="900" data-label="Hamburguesa doble bacon cheese">Doble bacon cheese (~900 kcal)</option>
          </optgroup>
          <optgroup label="üç∫ Bebida">
            <option value="150" data-label="Cerveza 330 ml">Cerveza 330 ml (~150 kcal)</option>
            <option value="180" data-label="Cerveza artesana 330 ml">Cerveza artesana 330 ml (~180 kcal)</option>
            <option value="90" data-label="Copa vino tinto">Copa vino tinto (~90 kcal)</option>
            <option value="110" data-label="Copa vino blanco">Copa vino blanco (~110 kcal)</option>
            <option value="210" data-label="Gin-tonic">Gin-tonic (~210 kcal)</option>
            <option value="200" data-label="Ron-cola">Ron-cola (~200 kcal)</option>
            <option value="240" data-label="Mojito">Mojito (~240 kcal)</option>
            <!-- Bebidas y cocktails -->
                <option value="150" data-label="Cerveza 330 ml">Cerveza 330 ml (~150 kcal)</option>
                <option value="210" data-label="Gin-tonic est√°ndar">Gin-tonic est√°ndar (~210 kcal)</option>
                <option value="200" data-label="Ron-cola">Ron-cola (~200 kcal)</option>
                <option value="240" data-label="Mojito">Mojito (~240 kcal)</option>
                <option value="230" data-label="Sex on the Beach">Sex on the Beach (~230 kcal)</option>
                <option value="250" data-label="Caipiri√±a">Caipiri√±a (~250 kcal)</option>
                <option value="300" data-label="Pi√±a colada">Pi√±a colada (~300 kcal)</option>
                <option value="200" data-label="Whisky-cola">Whisky-cola (~200 kcal)</option>
                <option value="200" data-label="Aperol Spritz">Aperol Spritz (~200 kcal)</option>
                <option value="65" data-label="Chupito tequila">Chupito de tequila (~65 kcal)</option>
                <option value="90" data-label="Copa de vino tinto">Copa de vino tinto (~90 kcal)</option>
                <option value="110" data-label="Copa de vino blanco">Copa de vino blanco (~110 kcal)</option>
                <option value="120" data-label="Refresco azucarado 330 ml">Refresco azucarado 330 ml (~120 kcal)</option>
                <option value="100" data-label="Verm√∫">Verm√∫ (~100 kcal)</option>
                <option value="180" data-label="Cerveza artesana 330 ml">Cerveza artesana 330 ml (~180 kcal)</option>
          </optgroup>
        </select>

        <div class="hint">
          <span data-i18n="food.searchHint">¬øNo est√° en la lista? Busca en Open Food Facts (beta).</span>
          <span class="linklike" id="openFoodSearch" data-i18n="food.searchLink">Abrir buscador</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="unidades" data-i18n="food.unitsLabel">N.¬∫ de unidades</label>
            <input id="unidades" type="number" min="1" step="1" value="1" />
            <div class="hint" data-i18n="food.unitsHint">Ej: 3 cervezas ‚Üí pon 3 unidades.</div>
          </div>
          <div>
            <label for="customKcal" data-i18n="food.extraLabel">Calor√≠as extra</label>
            <input id="customKcal" type="number" min="0" step="1" placeholder="0" />
            <div class="hint" data-i18n="food.extraHint">Se suman a lo anterior (comida + copas).</div>
          </div>
        </div>

        <!-- Panel Open Food Facts -->
        <div class="panel" id="foodSearchPanel">
          <div class="topline" style="margin-bottom:6px;">
            <div>
              <div style="font-weight:900" data-i18n="foodSearch.title">Buscador (Open Food Facts)</div>
              <div class="muted" style="margin-top:2px;" data-i18n="foodSearch.subtitle">
                Escribe un producto. Te devolvemos resultados con kcal/100g y puedes a√±adirlo a la lista.
              </div>
            </div>
            <button class="btn btn-secondary" type="button" id="btnFoodSearchClose" data-i18n="foodSearch.close">Cerrar</button>
          </div>

          <div class="row">
            <div>
              <label for="foodQuery" data-i18n="foodSearch.queryLabel">Buscar</label>
              <input id="foodQuery" placeholder="pizza pepperoni, cerveza 0,0..." />
              <div class="hint" data-i18n="foodSearch.queryHint">Consejo: a√±ade marca o tipo (‚Äúpizza pepperoni‚Äù, ‚Äúcerveza 0,0‚Äù).</div>
            </div>
            <div>
              <label for="foodServing" data-i18n="foodSearch.servingLabel">Raci√≥n (g/ml)</label>
              <input id="foodServing" type="number" min="0" step="1" placeholder="250" />
              <div class="hint" data-i18n="foodSearch.servingHint">Para convertir kcal/100g a tu raci√≥n.</div>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" type="button" id="btnFoodSearch" data-i18n="foodSearch.btn">Buscar</button>
            <div class="muted" style="align-self:center;">
              <b data-i18n="foodSearch.disclaimerTitle">Beta:</b>
              <span data-i18n="foodSearch.disclaimerBody">Los datos vienen de un repositorio abierto (usuarios suben productos). Puede haber errores.</span>
            </div>
          </div>

          <div class="share-status" id="foodSearchStatus" style="display:none;margin-top:10px;"></div>
          <div id="foodSearchResults" style="display:none;"></div>
        </div>

        <button class="btn btn-primary btn-wide" id="btnCalcular" type="button" data-i18n="btn.calculate">
          CALCULAR EJERCICIO NECESARIO üí™
        </button>
      </section>
    </div>

    <!-- RESULTADOS + MEME + COMPARTIR (EL PRODUCTO) -->
    <section class="card" id="resultsSection" style="margin-top:16px;">
      <div class="results-head">
        <h2>üéØ <span data-i18n="results.title">Resultados del castigo cal√≥rico</span></h2>
        <span class="badge kcal" id="kcalBadge">0 kcal</span>
      </div>

      <div class="phrase" id="phraseBox" data-i18n="phrase.initial">
        Introduce tu peso, elige comida o bebida, y pulsa en <strong>‚ÄúCalcular ejercicio necesario‚Äù</strong>. Luego decide si prefieres correr, bailar, jugar al p√°del‚Ä¶ o abrazar la petanca.
      </div>

      <div class="tabs" id="peopleTabs"></div>

      <div id="tableWrapper" style="display:none;">
        <table>
          <thead>
            <tr>
              <th data-i18n="table.activity">Actividad</th>
              <th data-i18n="table.time">Tiempo aprox.</th>
              <th data-i18n="table.distance">Distancia aprox.</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

      <div class="meme">
        <canvas id="memeCanvas" width="1200" height="630" aria-label="Meme generado"></canvas>

        <div class="share-row">
          <button class="btn btn-primary" type="button" id="btnShare" data-i18n="share.btnShare">Compartir</button>
          <button class="btn btn-secondary" type="button" id="btnGenMeme" data-i18n="share.btnGen">Generar meme</button>
          <button class="btn btn-secondary" type="button" id="btnDownload" data-i18n="share.btnDownload">Descargar imagen</button>
          <button class="btn btn-secondary" type="button" id="btnCopyText" data-i18n="share.btnCopy">Copiar texto</button>
          <div class="share-status" id="shareStatus"></div>
        </div>
      </div>

      <div class="disclaimer" id="disclaimer" data-i18n="disclaimer"></div>
    </section>

    <!-- OPCIONES AVANZADAS (PLEGABLES) -->
    <section class="card" style="margin-top:16px;">
      <div class="topline">
        <h2>üß© Opciones avanzadas</h2>
        <span class="badge">‚ÄúMods‚Äù del simulador</span>
      </div>
      <p class="subtitle">Esto es opcional. El flujo principal arriba ya funciona perfecto.</p>

      <!-- Batalla -->
      <details id="battleDetails" class="acc">
        <summary><span data-i18n="battle.toggleTitle">Batalla de colegas</span> <span class="muted">‚ñº</span></summary>
        <div class="acc-body">
          <h3 style="margin:0 0 6px;" data-i18n="battle.title">Batalla de colegas</h3>
          <div class="muted" style="margin-bottom:10px;" data-i18n="battle.hint">
            Si nadie aqu√≠ tiene peso v√°lido, solo te usamos a ti. Si los rellenas, todos comparten castigo cal√≥rico.
          </div>

          <div class="row">
            <div>
              <label data-i18n="battle.name1" for="friend1Name">Nombre 1</label>
              <input id="friend1Name" placeholder="Alex" />
            </div>
            <div>
              <label data-i18n="battle.weight1" for="friend1Weight">Peso 1 (kg)</label>
              <input id="friend1Weight" type="number" min="30" max="250" step="0.1" placeholder="75" />
            </div>
          </div>

          <div class="row">
            <div>
              <label data-i18n="battle.name2" for="friend2Name">Nombre 2</label>
              <input id="friend2Name" placeholder="Colega 2" />
            </div>
            <div>
              <label data-i18n="battle.weight2" for="friend2Weight">Peso 2 (kg)</label>
              <input id="friend2Weight" type="number" min="30" max="250" step="0.1" placeholder="85" />
            </div>
          </div>

          <div class="row">
            <div>
              <label data-i18n="battle.name3" for="friend3Name">Nombre 3</label>
              <input id="friend3Name" placeholder="Colega 3" />
            </div>
            <div>
              <label data-i18n="battle.weight3" for="friend3Weight">Peso 3 (kg)</label>
              <input id="friend3Weight" type="number" min="30" max="250" step="0.1" placeholder="68" />
            </div>
          </div>
        </div>
      </details>

      <!-- Copas -->
      <details id="drinksDetails" class="acc">
        <summary><span data-i18n="drinks.toggleTitle">Modo noche de copas</span> <span class="muted">‚ñº</span></summary>
        <div class="acc-body">
          <h3 style="margin:0 0 6px;" data-i18n="drinks.title">Noche de copas</h3>
          <div class="muted" style="margin-bottom:10px;" data-i18n="drinks.hint">
            Perfecto para ver cu√°nto ‚Äúvale‚Äù tu noche de copas adem√°s de la cena.
          </div>

          <div class="row">
            <div>
              <label for="drinkSelect" data-i18n="drinks.drinkLabel">Bebida</label>
              <select id="drinkSelect">
                <option value="0">‚Äî</option>
                <option value="150">Cerveza 330 ml (~150 kcal)</option>
                <option value="180">Cerveza artesana 330 ml (~180 kcal)</option>
                <option value="90">Copa vino tinto (~90 kcal)</option>
                <option value="110">Copa vino blanco (~110 kcal)</option>
                <option value="210">Gin-tonic (~210 kcal)</option>
                <option value="200">Ron-cola (~200 kcal)</option>
                <option value="240">Mojito (~240 kcal)</option>
                <option value="65">Chupito tequila (~65 kcal)</option>
                <option value="120">Refresco 330 ml (~120 kcal)</option>
              </select>
              <div class="hint" data-i18n="drinks.chipText">Estas calor√≠as se suman al resto.</div>
            </div>
            <div>
              <label for="numCopas" data-i18n="drinks.numLabel">N.¬∫ de copas</label>
              <input id="numCopas" type="number" min="0" step="1" value="0" />
            </div>
          </div>
        </div>
      </details>

      <!-- Inversa -->
      <details id="inverseDetails" class="acc">
        <summary><span data-i18n="inverse.title">Calculadora inversa (modo precavido)</span> <span class="muted">‚ñº</span></summary>
        <div class="acc-body" id="inverseBlock">
          <div class="row">
            <div>
              <label for="invKm" data-i18n="inverse.kmLabel">Ma√±ana corro (km)</label>
              <input id="invKm" type="number" min="0" step="0.1" placeholder="10" />
              <div class="hint" data-i18n="inverse.kmHint">Regla r√°pida: correr ‚âà 1 kcal por kg por km (aprox).</div>
            </div>
            <div>
              <label for="invIntensity" data-i18n="inverse.intensityLabel">Intensidad</label>
              <select id="invIntensity">
                <option value="0.9" data-i18n="inverse.intensityEasy">Suave</option>
                <option value="1.0" selected data-i18n="inverse.intensityMid">Media</option>
                <option value="1.15" data-i18n="inverse.intensityHard">Fuerte</option>
              </select>
              <div class="hint" data-i18n="inverse.intensityHint">Ajuste simple: +/‚àí seg√∫n intensidad.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="invDrink" data-i18n="inverse.drinkLabel">¬øEn qu√© ‚Äúte lo quieres gastar‚Äù?</label>
              <select id="invDrink">
                <option value="150" data-i18n="inverse.drinkBeer">Cerveza 330 ml (~150 kcal)</option>
                <option value="180" data-i18n="inverse.drinkBeerCraft">Cerveza artesana 330 ml (~180 kcal)</option>
                <option value="90" data-i18n="inverse.drinkWineRed">Copa vino tinto (~90 kcal)</option>
                <option value="110" data-i18n="inverse.drinkWineWhite">Copa vino blanco (~110 kcal)</option>
                <option value="210" data-i18n="inverse.drinkGin">Gin-tonic (~210 kcal)</option>
                <option value="200" data-i18n="inverse.drinkRum">Ron-cola (~200 kcal)</option>
                <option value="240" data-i18n="inverse.drinkMojito">Mojito (~240 kcal)</option>
                <option value="65" data-i18n="inverse.drinkShot">Chupito tequila (~65 kcal)</option>
                <option value="120" data-i18n="inverse.drinkSoda">Refresco 330 ml (~120 kcal)</option>
              </select>
            </div>
            <div>
              <label for="invExtraMargin" data-i18n="inverse.marginLabel">Margen ‚Äúpor si acaso‚Äù</label>
              <select id="invExtraMargin">
                <option value="0.85" data-i18n="inverse.marginHigh">Alto (85%)</option>
                <option value="0.70" selected data-i18n="inverse.marginMid">Medio (70%)</option>
                <option value="0.55" data-i18n="inverse.marginLow">Bajo (55%)</option>
              </select>
              <div class="hint" data-i18n="inverse.marginHint">Porque luego hay cena. Y postre. Y ‚Äúuna √∫ltima‚Äù.</div>
            </div>
          </div>

          <button class="btn btn-primary btn-wide" type="button" id="btnInverse" data-i18n="inverse.btn">¬øCu√°nto puedo beber?</button>
          <div class="panel" id="inverseOut" style="display:none;"></div>
        </div>
      </details>

      <!-- Stats local -->
      <details id="statsDetails" class="acc" open>
        <summary><span data-i18n="stats.title">Ranking semanal (an√≥nimo)</span> <span class="muted">‚ñº</span></summary>
        <div class="acc-body">
          <div class="muted" data-i18n="stats.noteBody">
            No grabamos estad√≠sticas globales de todos los usuarios. As√≠ que este ranking es <strong>local en tu dispositivo</strong>.
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="card" style="padding:12px; background:rgba(5,8,24,.35)">
              <div class="muted" data-i18n="stats.weekKcalLabel">Kcal acumuladas (7 d√≠as)</div>
              <div style="font-size:1.6rem; font-weight:900; margin-top:4px;"><span id="weekKcal">0</span></div>
            </div>
            <div class="card" style="padding:12px; background:rgba(5,8,24,.35)">
              <div class="muted" data-i18n="stats.weekKmLabel">Km ‚Äúculpa de la fiesta‚Äù (7 d√≠as)</div>
              <div style="font-size:1.6rem; font-weight:900; margin-top:4px;"><span id="weekKm">0</span></div>
            </div>
          </div>

          <div class="card" style="padding:12px; background:rgba(5,8,24,.35); margin-top:10px;">
            <div class="muted" data-i18n="stats.yearTopLabel">Top castigo (este a√±o)</div>
            <div style="font-weight:900; margin-top:6px;"><span id="yearTop">‚Äî</span></div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn btn-secondary" id="btnResetStats" type="button" data-i18n="stats.reset">Resetear stats (local)</button>
            <button class="btn btn-primary" id="btnShareStats" type="button" data-i18n="stats.share">Compartir mi ‚Äúranking‚Äù</button>
          </div>

          <div class="share-status" id="statsHeadline" style="display:none;margin-top:10px;"></div>
        </div>
      </details>
    </section>
  </div>

  <script>
    // --- Idioma actual ---
    let currentLang = 'es';

    // --- GA4 helper (single HTML friendly) ---
    function gaEvent(name, params = {}) {
      try { if (window.gtag) window.gtag('event', name, params); } catch (e) { /* silent */ }
    }

    // -------- I18N (lo importante) --------
    const I18N = {
      es: {
        'doc.title': 'LoVasASudar.com ‚Äì Calculadora de castigo cal√≥rico de fiesta',
        'header.pill': 'LoVasASudar.com ¬∑ Calculadora de castigo cal√≥rico',
        'header.title': 'LoVasASudar.com',
        'header.subtitle': 'Mete lo que vas a comer y beber y descubre cu√°nto ejercicio tendr√≠as que hacer para sudarlo. Perfecta para cenas con amigos y noches de copas.',

        'profile.title': 'Tu perfil',
        'profile.subtitle': 'Pon tus datos b√°sicos para estimar el gasto.',
        'profile.badge': '0% serio, 100% fiesta',
        'profile.weightLabel': 'Peso (kg)',
        'profile.weightHint': 'El c√°lculo se hace por kg de peso (ecuaci√≥n basada en MET).',
        'profile.genderLabel': 'G√©nero (opcional)',
        'profile.genderHint': 'A igualdad de peso, hombres y mujeres suelen quemar algo diferente. Aqu√≠ aplicamos un ajuste sencillo (~5%) para reflejarlo de forma aproximada.',

        'food.title': 'Lo que vas a tomar',
        'food.subtitle': 'Elige algo conocido o pon t√∫ las calor√≠as.',
        'food.badge': 'Modo noche de fiesta üåô',
        'food.labelMain': 'Alimento o bebida (lista ‚Äúde culto‚Äù)',
        'food.unitsLabel': 'N.¬∫ de unidades',
        'food.unitsHint': 'Ej: 3 cervezas ‚Üí pon 3 unidades.',
        'food.extraLabel': 'Calor√≠as extra',
        'food.extraHint': 'Se suman a lo anterior (comida + copas).',
        'food.searchHint': '¬øNo est√° en la lista? Busca en Open Food Facts (beta).',
        'food.searchLink': 'Abrir buscador',

        'foodSearch.title': 'Buscador (Open Food Facts)',
        'foodSearch.subtitle': 'Escribe un producto. Te devolvemos resultados con kcal/100g y puedes a√±adirlo a la lista.',
        'foodSearch.queryLabel': 'Buscar',
        'foodSearch.queryHint': 'Consejo: a√±ade marca o tipo (‚Äúpizza pepperoni‚Äù, ‚Äúcerveza 0,0‚Äù).',
        'foodSearch.servingLabel': 'Raci√≥n (g/ml)',
        'foodSearch.servingHint': 'Para convertir kcal/100g a tu raci√≥n.',
        'foodSearch.btn': 'Buscar',
        'foodSearch.close': 'Cerrar',
        'foodSearch.disclaimerTitle': 'Beta:',
        'foodSearch.disclaimerBody': 'Los datos vienen de un repositorio abierto (usuarios suben productos). Puede haber errores.',

        'btn.calculate': 'CALCULAR EJERCICIO NECESARIO üí™',

        'results.title': 'Resultados del castigo cal√≥rico',
        'table.activity': 'Actividad',
        'table.time': 'Tiempo aprox.',
        'table.distance': 'Distancia aprox.',

        'share.btnGen': 'Generar meme',
        'share.btnShare': 'Compartir',
        'share.btnDownload': 'Descargar imagen',
        'share.btnCopy': 'Copiar texto',

        'battle.toggleTitle': 'Batalla de colegas',
        'battle.title': 'Batalla de colegas',
        'battle.name1': 'Nombre 1',
        'battle.weight1': 'Peso 1 (kg)',
        'battle.name2': 'Nombre 2',
        'battle.weight2': 'Peso 2 (kg)',
        'battle.name3': 'Nombre 3',
        'battle.weight3': 'Peso 3 (kg)',
        'battle.hint': 'Si nadie aqu√≠ tiene peso v√°lido, solo te usamos a ti. Si los rellenas, todos comparten castigo cal√≥rico.',

        'drinks.toggleTitle': 'Modo noche de copas',
        'drinks.title': 'Noche de copas',
        'drinks.drinkLabel': 'Bebida',
        'drinks.numLabel': 'N.¬∫ de copas',
        'drinks.chipText': 'Estas calor√≠as se suman al resto.',
        'drinks.hint': 'Perfecto para ver cu√°nto ‚Äúvale‚Äù tu noche de copas adem√°s de la cena.',

        'inverse.title': 'Calculadora inversa (modo precavido)',
        'inverse.kmLabel': 'Ma√±ana corro (km)',
        'inverse.kmHint': 'Regla r√°pida: correr ‚âà 1 kcal por kg por km (aprox).',
        'inverse.intensityLabel': 'Intensidad',
        'inverse.intensityEasy': 'Suave',
        'inverse.intensityMid': 'Media',
        'inverse.intensityHard': 'Fuerte',
        'inverse.intensityHint': 'Ajuste simple: +/‚àí seg√∫n intensidad.',
        'inverse.drinkLabel': '¬øEn qu√© ‚Äúte lo quieres gastar‚Äù?',
        'inverse.marginLabel': 'Margen ‚Äúpor si acaso‚Äù',
        'inverse.marginHigh': 'Alto (85%)',
        'inverse.marginMid': 'Medio (70%)',
        'inverse.marginLow': 'Bajo (55%)',
        'inverse.marginHint': 'Porque luego hay cena. Y postre. Y ‚Äúuna √∫ltima‚Äù.',
        'inverse.btn': '¬øCu√°nto puedo beber?',

        'stats.title': 'Ranking semanal (an√≥nimo)',
        'stats.noteBody': 'Este ranking es <strong>local en tu dispositivo</strong> (sirve para ‚Äúpicar‚Äù a tus colegas).',
        'stats.weekKcalLabel': 'Kcal acumuladas (7 d√≠as)',
        'stats.weekKmLabel': 'Km ‚Äúculpa de la fiesta‚Äù (7 d√≠as)',
        'stats.yearTopLabel': 'Top castigo (este a√±o)',
        'stats.reset': 'Resetear stats (local)',
        'stats.share': 'Compartir mi ‚Äúranking‚Äù',

        'phrase.initial': 'Introduce tu peso, elige comida o bebida, y pulsa en <strong>‚ÄúCalcular ejercicio necesario‚Äù</strong>. Luego decide si prefieres correr, bailar, jugar al p√°del‚Ä¶ o abrazar la petanca.',
        'disclaimer': '<strong>Nota seria dentro de la broma:</strong> los c√°lculos usan la f√≥rmula est√°ndar basada en MET (equivalentes metab√≥licos) multiplicados por tu peso y un peque√±o ajuste por g√©nero cuando se indica. Son aproximaciones pensadas para concienciar y divertir, no para prescripci√≥n m√©dica ni deportiva profesional.',

        'gender.opt0': 'Prefiero no decirlo',
        'gender.optMale': 'Hombre',
        'gender.optFemale': 'Mujer',
        'gender.optOther': 'Otro'
      },
      en: {
        'doc.title': 'LoVasASudar.com ‚Äì Party calorie punishment calculator',
        'header.pill': 'LoVasASudar.com ¬∑ Calorie punishment calculator',
        'header.title': 'LoVasASudar.com',
        'header.subtitle': 'Enter what you are going to eat and drink and see how much exercise you would need to sweat it out. Perfect for dinners with friends and party nights.',

        'profile.title': 'Your profile',
        'profile.subtitle': 'Fill your basic data to estimate energy cost.',
        'profile.badge': '0% serious, 100% party',
        'profile.weightLabel': 'Weight (kg)',
        'profile.weightHint': 'The calculation uses your weight in kg (MET-based equation).',
        'profile.genderLabel': 'Gender (optional)',
        'profile.genderHint': 'For the same weight, men and women often burn slightly different amounts. We apply a simple (~5%) adjustment to reflect that roughly.',

        'food.title': 'What you‚Äôre having',
        'food.subtitle': 'Pick something from the list or enter calories yourself.',
        'food.badge': 'Party night mode üåô',
        'food.labelMain': 'Food or drink (cult list)',
        'food.unitsLabel': 'Number of units',
        'food.unitsHint': 'Example: 3 beers ‚Üí enter 3 units.',
        'food.extraLabel': 'Extra calories',
        'food.extraHint': 'These are added on top (food + drinks).',
        'food.searchHint': 'Not on the list? Search Open Food Facts (beta).',
        'food.searchLink': 'Open search',

        'foodSearch.title': 'Search (Open Food Facts)',
        'foodSearch.subtitle': 'Type a product. We show kcal/100g and you can add it to the list.',
        'foodSearch.queryLabel': 'Search',
        'foodSearch.queryHint': 'Tip: add brand/type (‚Äúpepperoni pizza‚Äù, ‚Äú0.0 beer‚Äù).',
        'foodSearch.servingLabel': 'Serving (g/ml)',
        'foodSearch.servingHint': 'Convert kcal/100g to your serving.',
        'foodSearch.btn': 'Search',
        'foodSearch.close': 'Close',
        'foodSearch.disclaimerTitle': 'Beta:',
        'foodSearch.disclaimerBody': 'Data comes from an open repository (user-submitted products). Errors may exist.',

        'btn.calculate': 'CALCULATE REQUIRED EXERCISE üí™',

        'results.title': 'Calorie punishment results',
        'table.activity': 'Activity',
        'table.time': 'Approx. time',
        'table.distance': 'Approx. distance',

        'share.btnGen': 'Generate meme',
        'share.btnShare': 'Share',
        'share.btnDownload': 'Download image',
        'share.btnCopy': 'Copy text',

        'battle.toggleTitle': 'Friends battle',
        'battle.title': 'Friends battle',
        'battle.name1': 'Name 1',
        'battle.weight1': 'Weight 1 (kg)',
        'battle.name2': 'Name 2',
        'battle.weight2': 'Weight 2 (kg)',
        'battle.name3': 'Name 3',
        'battle.weight3': 'Weight 3 (kg)',
        'battle.hint': 'If no valid weight is set here, only you are used. If you fill them, everyone shares the calorie punishment.',

        'drinks.toggleTitle': 'Night drinks mode',
        'drinks.title': 'Night of drinks',
        'drinks.drinkLabel': 'Drink',
        'drinks.numLabel': 'Number of drinks',
        'drinks.chipText': 'These calories are added to the total.',
        'drinks.hint': 'Perfect to see how much your drinks ‚Äúcost‚Äù on top of dinner.',

        'inverse.title': 'Inverse calculator (cautious mode)',
        'inverse.kmLabel': 'Tomorrow I run (km)',
        'inverse.kmHint': 'Quick rule: running ‚âà 1 kcal per kg per km (rough).',
        'inverse.intensityLabel': 'Intensity',
        'inverse.intensityEasy': 'Easy',
        'inverse.intensityMid': 'Medium',
        'inverse.intensityHard': 'Hard',
        'inverse.intensityHint': 'Simple adjustment by intensity.',
        'inverse.drinkLabel': 'Spend it on‚Ä¶',
        'inverse.marginLabel': 'Safety margin',
        'inverse.marginHigh': 'High (85%)',
        'inverse.marginMid': 'Medium (70%)',
        'inverse.marginLow': 'Low (55%)',
        'inverse.marginHint': 'Because dinner happens. And dessert. And ‚Äúone last one‚Äù.',
        'inverse.btn': 'How much can I drink?',

        'stats.title': 'Weekly ranking (anonymous)',
        'stats.noteBody': 'This ranking is local on your device (good for viral ‚Äúchallenge‚Äù vibes).',
        'stats.weekKcalLabel': 'Calories accumulated (7 days)',
        'stats.weekKmLabel': '‚ÄúParty guilt‚Äù km (7 days)',
        'stats.yearTopLabel': 'Top punishment (this year)',
        'stats.reset': 'Reset stats (local)',
        'stats.share': 'Share my ‚Äúranking‚Äù',

        'phrase.initial': 'Enter your weight, choose food or drinks and click <strong>‚ÄúCalculate required exercise‚Äù</strong>. Then decide if you want to run, dance, play padel‚Ä¶ or fully embrace p√©tanque.',
        'disclaimer': '<strong>Serious note behind the joke:</strong> calculations use the standard MET-based formula (metabolic equivalents) multiplied by your weight, plus a small gender adjustment when given. These are rough estimates for awareness and fun, not medical or professional training advice.',

        'gender.opt0': 'Prefer not to say',
        'gender.optMale': 'Male',
        'gender.optFemale': 'Female',
        'gender.optOther': 'Other'
      }
    };

    const MESSAGES = {
      es: {
        errorUnits: 'Introduce un n√∫mero de unidades v√°lido (m√≠nimo 1).',
        errorWeight: 'Introduce tu peso en kg (entre 30 y 250 kg).',
        errorNoKcal: 'Necesitamos al menos alguna calor√≠a (comida, copas o extra) para calcular.',
        errorDrinksInvalid: 'Para el modo copas, elige una bebida y un n√∫mero de copas v√°lidos.',
        errorInverseKm: 'Introduce kil√≥metros v√°lidos (por ejemplo 10).',
        errorInverseNeedWeight: 'Para la inversa, necesitamos tu peso arriba.',
        copied: 'Copiado ‚úÖ',
        shareFail: 'Tu navegador no deja compartir archivo directamente. Descarga la imagen y comp√°rtela desde WhatsApp/Instagram.',
        memeNeedCalc: 'Primero calcula un castigo (arriba). Luego generamos el meme.',
        offEmpty: 'No encontr√© kcal en ese producto (o no ven√≠an). Prueba otro resultado o usa calor√≠as manuales.'
      },
      en: {
        errorUnits: 'Enter a valid number of units (minimum 1).',
        errorWeight: 'Enter your weight in kg (between 30 and 250 kg).',
        errorNoKcal: 'We need at least some calories (food, drinks or extra) to calculate.',
        errorDrinksInvalid: 'For drinks mode, choose a drink and a valid number of drinks.',
        errorInverseKm: 'Enter valid km (e.g., 10).',
        errorInverseNeedWeight: 'For inverse mode, we need your weight above.',
        copied: 'Copied ‚úÖ',
        shareFail: 'Your browser can‚Äôt share the image file directly. Download it and share via WhatsApp/Instagram.',
        memeNeedCalc: 'Calculate a punishment first. Then we generate the meme.',
        offEmpty: 'No kcal were found for that product. Try another result or enter calories manually.'
      }
    };

    const PHRASES = {
      es: [
        (k, l) => `Tu elecci√≥n (${l}) son aproximadamente ${k} kcal. No es pecado, pero el cuerpo te lo va a cobrar en sudor.`,
        (k, l) => `Eso que vas a tomar (${l}) equivale a una peque√±a negociaci√≥n con tu sistema cardiovascular: ${k} kcal en la mesa, a cambio de deporte despu√©s.`,
        (k, l) => `Si las calor√≠as fuesen una moneda, ${l} te est√° saliendo caro: ${k} monedas de sudor.`,
        (k, l) => `Buenas noticias: ${l} no es eterno. Malas noticias: las ${k} kcal tampoco desaparecen solas.`,
        (k, l) => `Tu ${l} es b√°sicamente un ‚Äúpr√©stamo‚Äù de ${k} kcal. Este simulador te ense√±a el plan de devoluci√≥n.`,
        (k, l) => `Esto (${l}) son ${k} kcal. No hace falta sentirse culpable, pero s√≠ responsable‚Ä¶ o al menos re√≠rse un rato calculando el castigo.`
      ],
      en: [
        (k, l) => `Your choice (${l}) is roughly ${k} kcal. Not a crime, but your body will charge interest in sweat.`,
        (k, l) => `What you're having (${l}) is a small negotiation with your cardiovascular system: ${k} kcal on the table, exercise as repayment.`,
        (k, l) => `If calories were a currency, ${l} is quite pricey: ${k} sweat coins.`,
        (k, l) => `Good news: ${l} won‚Äôt last forever. Bad news: those ${k} kcal won‚Äôt vanish by themselves.`,
        (k, l) => `Your ${l} is basically a ‚Äúloan‚Äù of ${k} kcal. This simulator shows your repayment plan.`,
        (k, l) => `This (${l}) is ${k} kcal. No need for guilt, just a bit of responsibility‚Ä¶ and maybe a laugh while you check the punishment.`
      ]
    };

    const ACTIVITIES = [
      { id: 'correr', name: { es: 'Correr', en: 'Running' }, met: 8.5, hasDistance: true, speed: 8, note: { es: 'trote alegre ~8 km/h', en: 'easy run ~8 km/h' } },
      { id: 'andar', name: { es: 'Andar r√°pido', en: 'Brisk walking' }, met: 3.8, hasDistance: true, speed: 5.5, note: { es: 'paseo ligero ~5,5 km/h', en: 'light walk ~5.5 km/h' } },
      { id: 'bailar', name: { es: 'Bailar', en: 'Dancing' }, met: 6, hasDistance: false, note: { es: 'discoteca / ‚ÄúManiac‚Äù vibes', en: 'club dancing / ‚ÄúManiac‚Äù vibes' } },
      { id: 'futbol', name: { es: 'F√∫tbol', en: 'Football / Soccer' }, met: 7, hasDistance: false, note: { es: 'partido informal con colegas', en: 'casual match with friends' } },
      { id: 'musculacion', name: { es: 'Musculaci√≥n (gym)', en: 'Weight training (gym)' }, met: 6, hasDistance: false, note: { es: 'entreno serio, no selfies', en: 'serious workout, not selfies' } },
      { id: 'spinning', name: { es: 'Spinning', en: 'Spinning' }, met: 9, hasDistance: false, note: { es: 'clase de bici indoor a tope', en: 'intense indoor cycling class' } },
      { id: 'bici_exterior', name: { es: 'Bicicleta exterior', en: 'Outdoor cycling' }, met: 7, hasDistance: true, speed: 18, note: { es: 'bici urbana / paseo r√°pido', en: 'urban / fast leisure cycling' } },
      { id: 'nadar', name: { es: 'Nadar', en: 'Swimming' }, met: 6.5, hasDistance: false, note: { es: 'crol moderado', en: 'moderate freestyle' } },
      { id: 'padel', name: { es: 'P√°del', en: 'Padel' }, met: 7, hasDistance: false, note: { es: 'partido dobles', en: 'doubles match' } },
      { id: 'tenis', name: { es: 'Tenis', en: 'Tennis' }, met: 7.3, hasDistance: false, note: { es: 'partido recreativo', en: 'recreational match' } },
      { id: 'petanca', name: { es: 'Petanca', en: 'P√©tanque / boules' }, met: 2.5, hasDistance: false, note: { es: 's√≠, tambi√©n cuenta üòÑ', en: 'yes, this counts too üòÑ' } },
      { id: 'dardos', name: { es: 'Dardos', en: 'Darts' }, met: 2, hasDistance: false, note: { es: 'ideal para la noche de copas', en: 'perfect during a night out' } }
    ];

    let currentResults = { people: [], kcal: 0, label: '' };
    let activePersonIndex = 0;

    // --- local stats (device only) ---
    const LS_STATS_KEY = 'lvas_stats_v1';
    const LS_PICKED_FOODS_KEY = 'lvas_picked_foods_v1';

    function nowMs() { return Date.now(); }
    function thisYear() { return new Date().getFullYear(); }

    function safeParse(json, fallback) { try { return JSON.parse(json); } catch { return fallback; } }

    function getStats() {
      const raw = localStorage.getItem(LS_STATS_KEY);
      const base = safeParse(raw, null);
      if (base && typeof base === 'object') return base;
      return { events: [] };
    }
    function saveStats(stats) { localStorage.setItem(LS_STATS_KEY, JSON.stringify(stats)); }
    function addEventToStats(kcal, label) {
      const stats = getStats();
      stats.events = Array.isArray(stats.events) ? stats.events : [];
      stats.events.push({ ts: nowMs(), kcal: Math.max(0, Math.round(kcal)), label: (label || '').slice(0, 120) });
      if (stats.events.length > 600) stats.events = stats.events.slice(stats.events.length - 600);
      saveStats(stats);
      renderStatsUI();
    }
    function getEventsLastDays(days) {
      const cutoff = nowMs() - days * 24 * 60 * 60 * 1000;
      const stats = getStats();
      return (stats.events || []).filter(e => e && typeof e.ts === 'number' && e.ts >= cutoff);
    }
    function getYearEvents(year) {
      const stats = getStats();
      return (stats.events || []).filter(e => new Date(e.ts).getFullYear() === year);
    }
    function sumKcal(events) { return events.reduce((a, e) => a + (Number(e.kcal) || 0), 0); }
    function getTopEvent(events) {
      let top = null;
      for (const e of events) if (!top || (Number(e.kcal)||0) > (Number(top.kcal)||0)) top = e;
      return top;
    }

    function getPickedFoods() {
      const raw = localStorage.getItem(LS_PICKED_FOODS_KEY);
      const base = safeParse(raw, []);
      return Array.isArray(base) ? base : [];
    }
    function savePickedFoods(arr) {
      localStorage.setItem(LS_PICKED_FOODS_KEY, JSON.stringify(arr.slice(0, 120)));
    }

    function tMsg(code) { return (MESSAGES[currentLang] && MESSAGES[currentLang][code]) || code; }
    function randomPhrase(kcal, label) {
      const arr = PHRASES[currentLang] || PHRASES.es;
      const idx = Math.floor(Math.random() * arr.length);
      return arr[idx](kcal, label || (currentLang === 'en' ? 'your choice' : 'tu elecci√≥n'));
    }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function formatMinutes(mins) {
      if (mins < 1) return currentLang === 'en' ? 'less than 1 min' : 'menos de 1 min';
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      if (h === 0) return `${m} min`;
      if (m === 0) return `${h} h`;
      return `${h} h ${m} min`;
    }
    function formatDistance(km) {
      if (!km || km <= 0.05) return '‚Äî';
      if (km < 1) return `${(km * 1000).toFixed(0)} m`;
      if (km < 10) return `${km.toFixed(1)} km`;
      return `${km.toFixed(1)} km`;
    }

    // DOM
    const langButtons = document.querySelectorAll('.lang-btn');
    const pesoInput = document.getElementById('peso');
    const sexoSelect = document.getElementById('sexo');

    // details ‚Äúactivan‚Äù modos
    const battleDetails = document.getElementById('battleDetails');
    const drinksDetails = document.getElementById('drinksDetails');

    const friendInputs = [
      { name: document.getElementById('friend1Name'), weight: document.getElementById('friend1Weight') },
      { name: document.getElementById('friend2Name'), weight: document.getElementById('friend2Weight') },
      { name: document.getElementById('friend3Name'), weight: document.getElementById('friend3Weight') }
    ];

    const foodSelect = document.getElementById('foodSelect');
    const unidadesInput = document.getElementById('unidades');
    const customKcalInput = document.getElementById('customKcal');

    const drinkSelect = document.getElementById('drinkSelect');
    const numCopasInput = document.getElementById('numCopas');

    const btnCalcular = document.getElementById('btnCalcular');
    const errorBox = document.getElementById('errorBox');

    const phraseBox = document.getElementById('phraseBox');
    const kcalBadge = document.getElementById('kcalBadge');
    const peopleTabs = document.getElementById('peopleTabs');
    const tableWrapper = document.getElementById('tableWrapper');
    const resultsBody = document.getElementById('resultsBody');
    const disclaimerBox = document.getElementById('disclaimer');

    // Inversa
    const invKm = document.getElementById('invKm');
    const invIntensity = document.getElementById('invIntensity');
    const invDrink = document.getElementById('invDrink');
    const invExtraMargin = document.getElementById('invExtraMargin');
    const btnInverse = document.getElementById('btnInverse');
    const inverseOut = document.getElementById('inverseOut');

    // Meme/share
    const memeCanvas = document.getElementById('memeCanvas');
    const btnGenMeme = document.getElementById('btnGenMeme');
    const btnShare = document.getElementById('btnShare');
    const btnDownload = document.getElementById('btnDownload');
    const btnCopyText = document.getElementById('btnCopyText');
    const shareStatus = document.getElementById('shareStatus');

    // Stats UI
    const weekKcalEl = document.getElementById('weekKcal');
    const weekKmEl = document.getElementById('weekKm');
    const yearTopEl = document.getElementById('yearTop');
    const btnResetStats = document.getElementById('btnResetStats');
    const btnShareStats = document.getElementById('btnShareStats');
    const statsHeadline = document.getElementById('statsHeadline');

    // Open Food Facts
    const openFoodSearch = document.getElementById('openFoodSearch');
    const foodSearchPanel = document.getElementById('foodSearchPanel');
    const foodQuery = document.getElementById('foodQuery');
    const foodServing = document.getElementById('foodServing');
    const btnFoodSearch = document.getElementById('btnFoodSearch');
    const btnFoodSearchClose = document.getElementById('btnFoodSearchClose');
    const foodSearchStatus = document.getElementById('foodSearchStatus');
    const foodSearchResults = document.getElementById('foodSearchResults');

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
    }
    function clearError() {
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    }
    function showHint(el, txt) {
      el.textContent = txt;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 2400);
    }

    function applyLanguage(lang) {
      currentLang = lang;
      const dict = I18N[lang] || I18N.es;

      document.title = dict['doc.title'] || document.title;

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key] !== undefined) el.textContent = dict[key];
      });

      // OJO: estas llevan HTML
      if (!currentResults.kcal || currentResults.kcal <= 0) phraseBox.innerHTML = dict['phrase.initial'];
      disclaimerBox.innerHTML = dict['disclaimer'];

      // G√©nero options
      const opts = sexoSelect.options;
      if (opts[0]) opts[0].textContent = dict['gender.opt0'];
      if (opts[1]) opts[1].textContent = dict['gender.optMale'];
      if (opts[2]) opts[2].textContent = dict['gender.optFemale'];
      if (opts[3]) opts[3].textContent = dict['gender.optOther'];

      // Botones idioma
      langButtons.forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-lang') === lang));

      // Re-render si hay resultados
      if (currentResults.kcal > 0) {
        renderResults(currentResults.label);
        drawMemeToCanvas();
      }
      renderStatsUI();
    }

    // Eventos base UI
    langButtons.forEach(btn => btn.addEventListener('click', () => applyLanguage(btn.getAttribute('data-lang'))));

    btnCalcular.addEventListener('click', () => {
      gaEvent('calculate_click', { lang: currentLang });
      calcular();
    });

    [pesoInput, customKcalInput, unidadesInput].forEach(el => {
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); calcular(); }
      });
    });

    // Inversa
    btnInverse.addEventListener('click', runInverse);

    // Meme/share
    btnGenMeme.addEventListener('click', () => {
      if (!currentResults.kcal || currentResults.kcal <= 0) return showHint(shareStatus, tMsg('memeNeedCalc'));
      drawMemeToCanvas(true);
      showHint(shareStatus, currentLang === 'en' ? 'Meme generated ‚úÖ' : 'Meme generado ‚úÖ');
    });

    btnDownload.addEventListener('click', () => {
      if (!currentResults.kcal || currentResults.kcal <= 0) return showHint(shareStatus, tMsg('memeNeedCalc'));
      drawMemeToCanvas();
      const a = document.createElement('a');
      a.href = memeCanvas.toDataURL('image/png');
      a.download = 'lovasasudar-castigo.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnCopyText.addEventListener('click', async () => {
      const txt = buildShareText();
      try {
        await navigator.clipboard.writeText(txt);
        showHint(shareStatus, tMsg('copied'));
      } catch {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showHint(shareStatus, tMsg('copied'));
      }
    });

    btnShare.addEventListener('click', async () => {
      if (!currentResults.kcal || currentResults.kcal <= 0) return showHint(shareStatus, tMsg('memeNeedCalc'));

      drawMemeToCanvas();
      const txt = buildShareText();
      const dataUrl = memeCanvas.toDataURL('image/png');

      function dataURLtoBlob(dataurl) {
        const arr = dataurl.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) u8arr[n] = bstr.charCodeAt(n);
        return new Blob([u8arr], { type: mime });
      }

      const blob = dataURLtoBlob(dataUrl);
      const file = new File([blob], 'lovasasudar-castigo.png', { type: 'image/png' });

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ title: 'LoVasASudar.com', text: txt, files: [file] });
          showHint(shareStatus, currentLang === 'en' ? 'Shared ‚úÖ' : 'Compartido ‚úÖ');
          return;
        } catch {}
      }

      if (navigator.share) {
        try {
          await navigator.share({ title: 'LoVasASudar.com', text: txt, url: 'https://lovasasudar.com/' });
          showHint(shareStatus, currentLang === 'en' ? 'Shared text ‚úÖ' : 'Texto compartido ‚úÖ');
          return;
        } catch {}
      }

      showHint(shareStatus, tMsg('shareFail'));
    });

    // Stats
    btnResetStats.addEventListener('click', () => {
      localStorage.removeItem(LS_STATS_KEY);
      renderStatsUI();
      statsHeadline.style.display = 'none';
      showHint(shareStatus, currentLang === 'en' ? 'Stats reset ‚úÖ' : 'Stats reseteadas ‚úÖ');
    });

    btnShareStats.addEventListener('click', async () => {
      const headline = buildLocalHeadline();
      const txt = `${headline}\n\n${currentLang === 'en' ? 'Try yours:' : 'Haz el tuyo:'} https://lovasasudar.com/`;
      try {
        await navigator.clipboard.writeText(txt);
        statsHeadline.style.display = 'block';
        statsHeadline.textContent = headline;
        showHint(shareStatus, tMsg('copied'));
      } catch {
        statsHeadline.style.display = 'block';
        statsHeadline.textContent = headline;
        showHint(shareStatus, currentLang === 'en' ? 'Copied (fallback) ‚úÖ' : 'Copiado (fallback) ‚úÖ');
      }
    });

    // Open Food Facts panel
    openFoodSearch.addEventListener('click', () => {
      foodSearchPanel.style.display = (foodSearchPanel.style.display === 'none' || !foodSearchPanel.style.display) ? 'block' : 'none';
      if (foodSearchPanel.style.display === 'block') setTimeout(() => foodQuery.focus(), 50);
    });
    btnFoodSearchClose.addEventListener('click', () => { foodSearchPanel.style.display = 'none'; });
    btnFoodSearch.addEventListener('click', runFoodSearch);
    foodQuery.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); runFoodSearch(); } });

    // -------------------------
    // L√ìGICA PRINCIPAL CALCULAR
    // -------------------------
    function calcular() {
      clearError();

      let foodKcal = 0;
      let manualKcal = 0;
      let drinksKcal = 0;
      const labelParts = [];

      const unidades = parseInt(unidadesInput.value || '1', 10);
      const customKcal = parseFloat(customKcalInput.value);

      const selectedOption = foodSelect.options[foodSelect.selectedIndex];
      const foodValRaw = foodSelect.value;

      if (foodValRaw !== '0' && foodValRaw !== 'custom') {
        const base = parseFloat(foodValRaw || '0');
        if (base > 0) {
          if (!unidades || unidades <= 0) return showError(tMsg('errorUnits'));
          foodKcal = base * unidades;
          const labelFood = selectedOption.dataset.label || selectedOption.textContent;
          if (labelFood) labelParts.push(labelFood + (unidades > 1 ? ` x${unidades}` : ''));
        }
      }

      if (!isNaN(customKcal) && customKcal > 0) {
        manualKcal = customKcal;
        labelParts.push(currentLang === 'en' ? 'Extra calories' : 'Calor√≠as extra');
      }

      // ‚ÄúModo copas‚Äù activo si el details est√° abierto
      const drinksEnabled = !!drinksDetails?.open;
      if (drinksEnabled) {
        const kcalDrink = parseFloat(drinkSelect.value || '0');
        const n = parseInt(numCopasInput.value || '0', 10);
        if (kcalDrink > 0 && n > 0) {
          drinksKcal = kcalDrink * n;
          const drinkLabel = drinkSelect.options[drinkSelect.selectedIndex].textContent || (currentLang === 'en' ? 'Drinks' : 'Copas');
          labelParts.push(`${drinkLabel} x${n}`);
        } else if (kcalDrink > 0 || n > 0) {
          return showError(tMsg('errorDrinksInvalid'));
        }
      }

      const totalKcal = foodKcal + manualKcal + drinksKcal;
      if (totalKcal <= 0) return showError(tMsg('errorNoKcal'));

      let label = labelParts.join(' + ');
      if (!label) label = currentLang === 'en' ? 'Your choice' : 'Tu elecci√≥n';

      const mainPeso = parseFloat(pesoInput.value);
      if (isNaN(mainPeso) || mainPeso < 30 || mainPeso > 250) return showError(tMsg('errorWeight'));

      const sexo = sexoSelect.value;
      let sexFactor = 1;
      let sexLabel = '';
      if (sexo === 'hombre') { sexFactor = 1.0; sexLabel = currentLang === 'en' ? 'Male' : 'Hombre'; }
      else if (sexo === 'mujer') { sexFactor = 0.95; sexLabel = currentLang === 'en' ? 'Female' : 'Mujer'; }
      else if (sexo === 'otro') { sexFactor = 1.0; sexLabel = currentLang === 'en' ? 'Other' : 'Otro'; }

      let people = [];

      const battleEnabled = !!battleDetails?.open;
      if (battleEnabled) {
        friendInputs.forEach((f, idx) => {
          const w = parseFloat(f.weight.value);
          if (!isNaN(w) && w >= 30 && w <= 250) {
            const defaultName = (currentLang === 'en' ? 'Friend ' : 'Amigo ') + (idx + 1);
            const name = (f.name.value || defaultName).trim();
            people.push({ name, weight: w, sexFactor: 1, sexLabel: '' });
          }
        });

        if (people.length === 0) {
          people.push({ name: currentLang === 'en' ? 'You' : 'T√∫', weight: mainPeso, sexFactor, sexLabel });
        } else {
          people.unshift({ name: currentLang === 'en' ? 'You' : 'T√∫', weight: mainPeso, sexFactor, sexLabel });
        }
      } else {
        people.push({ name: currentLang === 'en' ? 'You' : 'T√∫', weight: mainPeso, sexFactor, sexLabel });
      }

      const peopleResults = people.map(person => {
        const rows = ACTIVITIES.map(act => {
          const factor = person.sexFactor || 1;
          const timeHours = totalKcal / (act.met * person.weight * factor);
          const timeMinutes = timeHours * 60;
          const distance = act.hasDistance ? act.speed * timeHours : null;
          return { activity: act, minutes: timeMinutes, distanceKm: distance };
        });
        return { person, rows };
      });

      currentResults.people = peopleResults;
      currentResults.kcal = totalKcal;
      currentResults.label = label;
      activePersonIndex = 0;

      renderResults(label);

      gaEvent('punishment_result', {
        lang: currentLang,
        kcal: Math.round(totalKcal),
        people: (peopleResults?.length || 1),
        has_drinks: (drinksEnabled ? 1 : 0),
        battle: (battleEnabled ? 1 : 0)
      });

      addEventToStats(totalKcal, label);

      drawMemeToCanvas();

      // UX: baja a resultados
      document.getElementById('resultsSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderResults(label) {
      const { people, kcal } = currentResults;

      if (!people || people.length === 0) {
        tableWrapper.style.display = 'none';
        peopleTabs.style.display = 'none';
        kcalBadge.style.display = 'none';
        return;
      }

      phraseBox.innerHTML = randomPhrase(Math.round(kcal), label);
      kcalBadge.textContent = `${Math.round(kcal)} kcal`;
      kcalBadge.style.display = 'inline-flex';

      if (people.length > 1) {
        renderPeopleTabs();
        peopleTabs.style.display = 'flex';
      } else {
        peopleTabs.style.display = 'none';
      }

      tableWrapper.style.display = 'block';
      renderPersonTable();
    }

    function renderPeopleTabs() {
      const { people } = currentResults;
      peopleTabs.innerHTML = '';
      people.forEach((entry, idx) => {
        const btn = document.createElement('button');
        const labelParts = [`${entry.person.name}`, `${entry.person.weight} kg`];
        if (entry.person.sexLabel) labelParts.push(entry.person.sexLabel);
        btn.innerHTML = `<span class="icon">üéØ</span>${labelParts.join(' ¬∑ ')}`;
        if (idx === activePersonIndex) btn.classList.add('active');
        btn.addEventListener('click', () => {
          activePersonIndex = idx;
          renderPersonTable();
          renderPeopleTabs();
          drawMemeToCanvas();
        });
        peopleTabs.appendChild(btn);
      });
    }

    function renderPersonTable() {
      const { people } = currentResults;
      if (!people || people.length === 0) return;

      const entry = people[activePersonIndex];
      resultsBody.innerHTML = '';

      entry.rows.forEach(row => {
        const tr = document.createElement('tr');

        const tdAct = document.createElement('td');
        const nameDiv = document.createElement('div');
        nameDiv.className = 'activity-name';
        nameDiv.textContent = row.activity.name[currentLang] || row.activity.name.es;

        const softDiv = document.createElement('div');
        softDiv.className = 'activity-soft';
        softDiv.textContent = row.activity.note[currentLang] || row.activity.note.es || '';

        tdAct.appendChild(nameDiv);
        tdAct.appendChild(softDiv);

        const tdTime = document.createElement('td');
        tdTime.textContent = formatMinutes(row.minutes);

        const tdDist = document.createElement('td');
        tdDist.textContent = row.activity.hasDistance ? formatDistance(row.distanceKm) : '‚Äî';

        tr.appendChild(tdAct);
        tr.appendChild(tdTime);
        tr.appendChild(tdDist);

        resultsBody.appendChild(tr);
      });
    }

    // -------------------------
    // CALCULADORA INVERSA
    // -------------------------
    function runInverse() {
      inverseOut.style.display = 'none';
      const w = parseFloat(pesoInput.value);
      if (isNaN(w) || w < 30 || w > 250) { showHint(shareStatus, tMsg('errorInverseNeedWeight')); return showError(tMsg('errorInverseNeedWeight')); }

      const km = parseFloat(invKm.value);
      if (isNaN(km) || km <= 0) { showHint(shareStatus, tMsg('errorInverseKm')); return showError(tMsg('errorInverseKm')); }

      const intensity = parseFloat(invIntensity.value || '1.0');
      const margin = parseFloat(invExtraMargin.value || '0.7');
      const drinkKcal = parseFloat(invDrink.value || '150');

      const gross = w * km * intensity;
      const usable = gross * margin;
      const units = usable / drinkKcal;

      const unitsRounded = Math.max(0, Math.floor(units * 10) / 10);
      const kcalRounded = Math.round(usable);

      const drinkLabel = invDrink.options[invDrink.selectedIndex]?.textContent || (currentLang === 'en' ? 'Drink' : 'Bebida');

      const msg = (currentLang === 'en')
        ? `<strong>Budget:</strong> ~${kcalRounded} kcal (after margin).<br><strong>You can ‚Äúspend‚Äù:</strong> ~${unitsRounded} √ó ${drinkLabel}.<br><span class="muted">Rule of thumb. Real life is messy (sadly).</span>`
        : `<strong>Presupuesto:</strong> ~${kcalRounded} kcal (tras margen).<br><strong>Te puedes ‚Äúgastar‚Äù:</strong> ~${unitsRounded} √ó ${drinkLabel}.<br><span class="muted">Regla r√°pida. La vida real es un poco m√°s ca√≥tica (y a veces peor).</span>`;

      inverseOut.innerHTML = msg;
      inverseOut.style.display = 'block';
    }

    // -------------------------
    // MEME GENERATOR (canvas)
    // -------------------------
    function buildShareText() {
      const kcal = Math.round(currentResults.kcal || 0);
      const who = currentResults.people?.[activePersonIndex]?.person?.name || (currentLang === 'en' ? 'Me' : 'Yo');
      const label = (currentResults.label || '').replace(/\s+/g, ' ').trim();
      const act = (currentLang === 'en')
        ? `I just computed my ‚Äúcalorie punishment‚Äù: ${kcal} kcal üòµ‚Äçüí´`
        : `Acabo de calcular mi ‚Äúcastigo cal√≥rico‚Äù: ${kcal} kcal üòµ‚Äçüí´`;
      const extra = label ? (currentLang === 'en' ? `\nCause: ${label}` : `\nCausa: ${label}`) : '';
      const cta = currentLang === 'en'
        ? `\nTry yours üëâ https://lovasasudar.com/`
        : `\nHaz el tuyo üëâ https://lovasasudar.com/`;
      return `${act}${extra}\n(${who})${cta}`;
    }

    function drawMemeToCanvas(forceFresh) {
      if (!memeCanvas) return;
      const ctx = memeCanvas.getContext('2d');
      if (!ctx) return;

      if (!currentResults.kcal || currentResults.kcal <= 0) return drawMemePlaceholder(ctx);

      const w = memeCanvas.width, h = memeCanvas.height;

      const g1 = ctx.createLinearGradient(0, 0, w, h);
      g1.addColorStop(0, 'rgba(91,124,250,0.85)');
      g1.addColorStop(0.55, 'rgba(12,16,39,0.95)');
      g1.addColorStop(1, 'rgba(255,91,203,0.70)');
      ctx.fillStyle = g1;
      ctx.fillRect(0, 0, w, h);

      ctx.globalAlpha = 0.08;
      for (let i = 0; i < 1200; i++) {
        const x = Math.random() * w;
        const y = Math.random() * h;
        const r = Math.random() * 2;
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      const pad = 54;
      const cardX = pad, cardY = 70, cardW = w - pad * 2, cardH = h - 160;

      roundRect(ctx, cardX, cardY, cardW, cardH, 26);
      ctx.fillStyle = 'rgba(5,8,24,0.72)';
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = 'rgba(255,255,255,0.16)';
      ctx.stroke();

      const kcal = Math.round(currentResults.kcal);
      const person = currentResults.people?.[activePersonIndex]?.person;
      const who = person?.name || (currentLang === 'en' ? 'You' : 'T√∫');
      const weightTxt = person?.weight ? `${person.weight} kg` : '';

      ctx.fillStyle = 'rgba(255,255,255,0.95)';
      ctx.font = '800 56px system-ui, -apple-system, Segoe UI, sans-serif';
      const title = currentLang === 'en' ? 'CALORIE PUNISHMENT' : 'CASTIGO CAL√ìRICO';
      ctx.fillText(title, cardX + 34, cardY + 78);

      ctx.font = '600 26px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.82)';
      ctx.fillText(`${who}${weightTxt ? ' ¬∑ ' + weightTxt : ''}`, cardX + 36, cardY + 120);

      ctx.font = '900 140px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,217,160,0.98)';
      ctx.fillText(`${kcal} kcal`, cardX + 34, cardY + 275);

      const lbl = (currentResults.label || '').slice(0, 90);
      const line1 = currentLang === 'en'
        ? 'Your body called. It wants its balance back.'
        : 'Tu cuerpo ha llamado. Quiere que devuelvas el pr√©stamo.';
      const line2 = lbl ? (currentLang === 'en' ? `Cause: ${lbl}` : `Causa: ${lbl}`) : '';

      ctx.font = '600 26px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.86)';
      ctx.fillText(line1, cardX + 36, cardY + 330);

      if (line2) {
        ctx.font = '600 24px system-ui, -apple-system, Segoe UI, sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.74)';
        wrapText(ctx, line2, cardX + 36, cardY + 370, cardW - 72, 30);
      }

      const rows = currentResults.people?.[activePersonIndex]?.rows || [];
      const top3 = rows.slice().sort((a, b) => a.minutes - b.minutes).slice(0, 3);

      const boxX = cardX + 34, boxY = cardY + cardH - 175, boxW = cardW - 68, boxH = 120;

      roundRect(ctx, boxX, boxY, boxW, boxH, 18);
      ctx.fillStyle = 'rgba(9,13,35,0.62)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(159,168,255,0.18)';
      ctx.lineWidth = 2;
      ctx.stroke();

      ctx.font = '800 22px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.90)';
      ctx.fillText(currentLang === 'en' ? 'FASTEST PAYBACK (approx.)' : 'DEVOLUCI√ìN M√ÅS R√ÅPIDA (aprox.)', boxX + 18, boxY + 32);

      ctx.font = '700 20px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.82)';
      top3.forEach((r, i) => {
        const y = boxY + 62 + i * 26;
        const name = r.activity.name[currentLang] || r.activity.name.es;
        const mins = formatMinutes(r.minutes);
        ctx.fillText(`${i + 1}. ${name}`, boxX + 18, y);
        const tw = ctx.measureText(mins).width;
        ctx.fillText(mins, boxX + boxW - 18 - tw, y);
      });

      ctx.font = '800 22px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.fillText('LoVasASudar.com', 54, h - 38);

      ctx.font = '600 20px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.72)';
      const url = 'lovasasudar.com';
      const tw = ctx.measureText(url).width;
      ctx.fillText(url, w - 54 - tw, h - 38);
    }

    function drawMemePlaceholder(ctx) {
      const w = memeCanvas.width, h = memeCanvas.height;

      const g1 = ctx.createLinearGradient(0, 0, w, h);
      g1.addColorStop(0, 'rgba(91,124,250,0.70)');
      g1.addColorStop(1, 'rgba(255,91,203,0.55)');
      ctx.fillStyle = g1;
      ctx.fillRect(0, 0, w, h);

      roundRect(ctx, 70, 90, w - 140, h - 180, 28);
      ctx.fillStyle = 'rgba(5,8,24,0.65)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 3;
      ctx.stroke();

      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.font = '900 64px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillText('LoVasASudar.com', 120, 200);

      ctx.font = '700 30px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      const txt = currentLang === 'en'
        ? 'Calculate your punishment and generate the meme.'
        : 'Calcula tu castigo y genera el meme.';
      wrapText(ctx, txt, 120, 260, w - 240, 40);

      ctx.font = '800 26px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,217,160,0.95)';
      ctx.fillText(currentLang === 'en' ? 'üî• READY TO GET EXPOSED' : 'üî• LISTO PARA QUEDAR RETRATADO', 120, h - 160);

      ctx.font = '700 22px system-ui, -apple-system, Segoe UI, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.72)';
      ctx.fillText('lovasasudar.com', 120, h - 120);
    }

    function roundRect(ctx, x, y, w, h, r) {
      const radius = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.arcTo(x + w, y, x + w, y + h, radius);
      ctx.arcTo(x + w, y + h, x, y + h, radius);
      ctx.arcTo(x, y + h, x, y, radius);
      ctx.arcTo(x, y, x + w, y, radius);
      ctx.closePath();
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      if (!text) return;
      const words = String(text).split(' ');
      let line = '';
      let yy = y;

      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;

        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line.trim(), x, yy);
          line = words[n] + ' ';
          yy += lineHeight;
        } else {
          line = testLine;
        }
      }
      if (line.trim()) ctx.fillText(line.trim(), x, yy);
    }

    // -------------------------
    // STATS (LOCAL)
    // -------------------------
    function getValidWeightOrFallback() {
      const w = parseFloat(pesoInput.value);
      if (!isNaN(w) && w >= 30 && w <= 250) return w;
      return 75; // fallback razonable
    }

    function renderStatsUI() {
      const weekEvents = getEventsLastDays(7);
      const yearEvents = getYearEvents(thisYear());

      const wk = sumKcal(weekEvents);
      const w = getValidWeightOrFallback();
      const wkKm = wk > 0 ? (wk / w) : 0; // regla r√°pida: ~1 kcal/kg/km

      weekKcalEl.textContent = Math.round(wk).toLocaleString();
      weekKmEl.textContent = (wkKm > 0 ? wkKm.toFixed(wkKm < 10 ? 1 : 0) : '0');

      const top = getTopEvent(yearEvents);
      if (!top) {
        yearTopEl.textContent = '‚Äî';
      } else {
        const lbl = (top.label || '').trim() || (currentLang === 'en' ? 'Your choice' : 'Tu elecci√≥n');
        yearTopEl.textContent = `${Math.round(top.kcal)} kcal ¬∑ ${lbl}`;
      }
    }

    function buildLocalHeadline() {
      const weekEvents = getEventsLastDays(7);
      const wk = Math.round(sumKcal(weekEvents));
      const w = getValidWeightOrFallback();
      const wkKm = wk > 0 ? (wk / w) : 0;

      if (currentLang === 'en') {
        return `My last 7 days: ${wk} kcal of ‚Äúparty punishment‚Äù (~${wkKm.toFixed(wkKm < 10 ? 1 : 0)} km).`;
      }
      return `Mis √∫ltimos 7 d√≠as: ${wk} kcal de ‚Äúcastigo‚Äù (~${wkKm.toFixed(wkKm < 10 ? 1 : 0)} km).`;
    }

    // -------------------------
    // OPEN FOOD FACTS (BETA)
    // -------------------------
    async function runFoodSearch() {
      foodSearchStatus.style.display = 'none';
      foodSearchResults.style.display = 'none';
      foodSearchResults.innerHTML = '';

      const q = (foodQuery.value || '').trim();
      if (!q) return;

      btnFoodSearch.disabled = true;
      btnFoodSearch.textContent = (currentLang === 'en') ? 'Searching‚Ä¶' : 'Buscando‚Ä¶';

      try {
        // API simple (search)
        const url =
          `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&action=process&json=1&page_size=10`;

        const res = await fetch(url, { method: 'GET' });
        const data = await res.json();

        const products = Array.isArray(data.products) ? data.products : [];
        if (!products.length) {
          foodSearchStatus.style.display = 'block';
          foodSearchStatus.textContent = (currentLang === 'en') ? 'No results.' : 'Sin resultados.';
          return;
        }

        const serving = parseFloat(foodServing.value || '0'); // g/ml, opcional

        foodSearchResults.style.display = 'block';

        products.forEach((p) => {
          const name = (p.product_name || p.generic_name || p.brands || 'Producto').trim();
          const brand = (p.brands || '').trim();
          const code = p.code ? String(p.code) : '';

          // kcal/100g puede venir por varios campos
          let kcal100 = null;
          const n = p.nutriments || {};
          if (typeof n['energy-kcal_100g'] === 'number') kcal100 = n['energy-kcal_100g'];
          else if (typeof n['energy-kcal'] === 'number') kcal100 = n['energy-kcal'];
          else if (typeof n['energy_100g'] === 'number') {
            // energy_100g suele estar en kJ -> convertir a kcal
            kcal100 = n['energy_100g'] / 4.184;
          }

          // si no hay kcal, mostramos pero deshabilitamos ‚ÄúA√±adir‚Äù
          const hasKcal = (kcal100 !== null && isFinite(kcal100) && kcal100 > 0);
          const kcal100Rounded = hasKcal ? Math.round(kcal100) : null;

          // si ponen raci√≥n, calculamos kcal por raci√≥n
          let perServing = null;
          if (hasKcal && serving && serving > 0) {
            perServing = kcal100 * (serving / 100);
          }

          const item = document.createElement('div');
          item.className = 'result-item';

          const left = document.createElement('div');
          left.innerHTML = `
            <div style="font-weight:900">${escapeHtml(name)}</div>
            <div class="meta">
              ${brand ? `<span>${escapeHtml(brand)}</span> ¬∑ ` : ''}
              ${code ? `<span class="muted">${escapeHtml(code)}</span> ¬∑ ` : ''}
              ${
                hasKcal
                  ? `<b>${kcal100Rounded} kcal/100g</b>${perServing ? ` ¬∑ ~${Math.round(perServing)} kcal/raci√≥n` : ''}`
                  : `<span class="muted">${escapeHtml(tMsg('offEmpty'))}</span>`
              }
            </div>
          `;

          const right = document.createElement('div');
          const btn = document.createElement('button');
          btn.className = 'btn btn-secondary';
          btn.type = 'button';
          btn.textContent = (currentLang === 'en') ? 'Add' : 'A√±adir';
          btn.disabled = !hasKcal;

          btn.addEventListener('click', () => {
            // A√±adimos como opci√≥n al selector principal
            const label = `${name}${brand ? ' ¬∑ ' + brand : ''}`.slice(0, 60);
            const kcalVal = perServing ? Math.round(perServing) : Math.round(kcal100); // si no hay serving, metemos kcal/100g (menos ideal pero √∫til)
            addCustomFoodOption(label, kcalVal);
            showHint(shareStatus, (currentLang === 'en') ? 'Added ‚úÖ' : 'A√±adido ‚úÖ');
          });

          right.appendChild(btn);

          item.appendChild(left);
          item.appendChild(right);

          foodSearchResults.appendChild(item);
        });

      } catch (e) {
        foodSearchStatus.style.display = 'block';
        foodSearchStatus.textContent = (currentLang === 'en')
          ? 'Search failed. Try again.'
          : 'Fall√≥ la b√∫squeda. Intenta de nuevo.';
      } finally {
        btnFoodSearch.disabled = false;
        btnFoodSearch.textContent = I18N[currentLang]?.['foodSearch.btn'] || (currentLang === 'en' ? 'Search' : 'Buscar');
      }
    }

    function addCustomFoodOption(label, kcal) {
      const k = Math.max(0, Math.round(Number(kcal) || 0));
      if (!k) return showHint(shareStatus, tMsg('offEmpty'));

      // guardamos en localStorage (lista de ‚Äútus a√±adidos‚Äù)
      const arr = getPickedFoods();
      // evita duplicados muy obvios
      const key = `${label}`.toLowerCase().slice(0, 60);
      const exists = arr.some(x => (x?.key || '') === key);
      const entry = { key, label: String(label).slice(0, 60), kcal: k };

      const next = exists
        ? arr.map(x => (x.key === key ? entry : x))
        : [entry, ...arr];

      savePickedFoods(next);
      rebuildFoodSelectExtras();

      // seleccionar el reci√©n a√±adido
      const opt = [...foodSelect.options].find(o => o.dataset && o.dataset.customKey === key);
      if (opt) {
        foodSelect.value = opt.value;
        unidadesInput.value = 1;
        customKcalInput.value = '';
      }
    }

    function rebuildFoodSelectExtras() {
      // elimina optgroup previo si existe
      const prev = foodSelect.querySelector('optgroup[data-custom="1"]');
      if (prev) prev.remove();

      const arr = getPickedFoods();
      if (!arr.length) return;

      const group = document.createElement('optgroup');
      group.label = (currentLang === 'en') ? '‚≠ê Your added items' : '‚≠ê Tus a√±adidos';
      group.setAttribute('data-custom', '1');

      arr.slice(0, 20).forEach(item => {
        const opt = document.createElement('option');
        opt.value = String(item.kcal || 0);
        opt.dataset.label = item.label;
        opt.dataset.customKey = item.key;
        opt.textContent = `${item.label} (~${Math.round(item.kcal)} kcal)`;
        group.appendChild(opt);
      });

      // lo insertamos justo despu√©s de la opci√≥n "‚Äî"
      const firstOpt = foodSelect.querySelector('option[value="0"]');
      if (firstOpt && firstOpt.parentNode === foodSelect) {
        foodSelect.insertBefore(group, firstOpt.nextSibling);
      } else {
        foodSelect.appendChild(group);
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }

    // -------------------------
    // INIT
    // -------------------------
    function init() {
      // Disclaimer inicial + stats + extras
      disclaimerBox.innerHTML = I18N[currentLang]?.['disclaimer'] || I18N.es['disclaimer'];
      renderStatsUI();
      rebuildFoodSelectExtras();

      // Placeholder del meme al cargar
      const ctx = memeCanvas.getContext('2d');
      drawMemePlaceholder(ctx);

      // panel OFF por defecto
      foodSearchPanel.style.display = 'none';

      // idioma inicial
      applyLanguage(currentLang);
    }

    init();
  </script>
</body>
</html>


