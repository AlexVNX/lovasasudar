<!doctype html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-RLQ6Y55SNC"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-RLQ6Y55SNC', { anonymize_ip: true });
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Calcula el castigo cal√≥rico de tu cena/noche de copas y genera un meme para compartir." />
  <meta name="theme-color" content="#0b0f2a" />

  <link rel="icon" type="image/png" href="favicon.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon-48.png" sizes="48x48" />
  <link rel="apple-touch-icon" href="lovasasudar-favicon-512.png" />

  <title>LoVasASudar.com ‚Äì Calculadora de castigo cal√≥rico</title>

  <style>
    :root{
      --bg0:#05071a;
      --bg1:#080b22;
      --card:#0b1030cc;
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --accent:#5b7cfa;
      --pink:#ff5bcb;
      --gold:#ffd9a0;
      --good:#54ffa7;
      --bad:#ff6b6b;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(91,124,250,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(255,91,203,.18), transparent 60%),
        radial-gradient(700px 500px at 50% 105%, rgba(91,124,250,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 36px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brandline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(5,8,24,.55);
      box-shadow: var(--shadow);
      font-weight:900;
      font-size:.9rem;
      color:rgba(255,255,255,.88);
    }
    .lang{display:flex; gap:8px; align-items:center;}
    .lang-btn{
      border:1px solid var(--stroke);
      background:rgba(5,8,24,.55);
      color:rgba(255,255,255,.82);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      transition:transform .08s ease, border-color .12s ease;
    }
    .lang-btn:hover{transform:translateY(-1px)}
    .lang-btn.active{
      border-color:rgba(91,124,250,.55);
      box-shadow:0 0 0 3px rgba(91,124,250,.18);
      color:rgba(255,255,255,.96);
    }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(11,16,48,.70), rgba(7,10,31,.62));
      box-shadow: var(--shadow);
      padding: 18px;
      position:relative;
      overflow:hidden;
    }
    /* Menos ‚Äúcuadro abstracto‚Äù: glow m√°s discreto */
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: calc(var(--r) + 2px);
      background: linear-gradient(90deg, rgba(91,124,250,.12), rgba(255,91,203,.10), rgba(91,124,250,.08));
      opacity:.50;
      filter: blur(16px);
      pointer-events:none;
    }
    .card > *{position:relative}

    .hero{
      text-align:left;
      padding: 18px;
    }
    .title{
      margin:0;
      font-size: clamp(1.55rem, 2.6vw, 2.15rem);
      font-weight: 950;
      letter-spacing:.2px;
    }
    .sub{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.4;
      max-width:none; /* clave: no recortes */
      font-size: 1.02rem;
    }

    /* === FORM ALINEADO: GRID √öNICO === */
    .form-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.65fr .70fr .95fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 860px){
      .form-grid{grid-template-columns:1fr;}
    }

    label{
      display:block;
      font-weight:900;
      margin:10px 0 6px;
      color:rgba(255,255,255,.92);
    }
    input, select, button{font:inherit}
    input, select{
      width:100%;
      min-height:52px; /* clave: alturas alineadas */
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      color:rgba(255,255,255,.92);
      padding: 13px 12px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, select:focus{
      border-color: rgba(91,124,250,.55);
      box-shadow: 0 0 0 3px rgba(91,124,250,.16);
    }

    .hint{
      margin-top:6px;
      color:var(--muted2);
      font-size:.92rem;
      line-height:1.35;
      max-width:none;
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      color: rgba(255,255,255,.92);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight:950;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, opacity .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-primary{
      border-color: rgba(91,124,250,.55);
      background: linear-gradient(90deg, rgba(91,124,250,.92), rgba(255,91,203,.82));
      color: rgba(255,255,255,.98);
      box-shadow: 0 18px 40px rgba(91,124,250,.18), 0 14px 40px rgba(255,91,203,.10);
    }
    .btn-secondary{
      border-color: rgba(159,168,255,.25);
      background: rgba(9,13,35,.62);
    }
    .btn-wide{
      width:100%;
      font-size: 1.1rem;
      letter-spacing:.2px;
      padding: 16px 16px;
      border-radius: 999px;
      margin-top:12px;
    }

    /* Chips: UNA sola l√≠nea (scroll) */
    .microbar{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      align-items:center;
      padding-bottom: 2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.40);
      font-weight:900;
      color:rgba(255,255,255,.84);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .chip input{ display:none; }
    .chip .dot{
      width:10px; height:10px; border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      background: transparent;
      box-shadow:0 0 0 0 rgba(91,124,250,.0);
      transition: all .12s ease;
    }
    .chip input:checked + .dot{
      border-color: rgba(91,124,250,.75);
      background: rgba(91,124,250,.9);
      box-shadow:0 0 0 3px rgba(91,124,250,.15);
    }

    .error{
      display:none;
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(35,10,12,.55);
      color: rgba(255,180,180,.96);
      font-weight:900;
    }

    .muted{color:var(--muted2)}
    .linklike{
      color: rgba(255,255,255,.92);
      text-decoration: underline;
      text-underline-offset: 3px;
      cursor:pointer;
      font-weight:900;
    }

    .advanced{ margin-top: 14px; display:none; }
    .advanced.show{ display:block; }

    details.acc{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.38);
      border-radius: 18px;
      padding: 0;
      overflow:hidden;
      margin-top: 10px;
    }
    details.acc summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 12px;
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(9,13,35,.45);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    details.acc summary::-webkit-details-marker{display:none}
    .acc-body{ padding: 12px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }

    /* Resultados */
    .results-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.55);
      font-weight:900;
      color:rgba(255,255,255,.85);
      font-size:.86rem;
    }
    .badge.kcal{
      border-color: rgba(255,217,160,.32);
      color: rgba(255,217,160,.95);
      background: rgba(25,18,5,.35);
      display:none;
    }

    .phrase{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.45);
      border-radius: 18px;
      padding: 12px 12px;
      color: rgba(255,255,255,.86);
      line-height:1.35;
      margin-bottom: 12px;
    }

    .tabs{
      display:none;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 10px;
    }
    .tabs button{
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.45);
      color: rgba(255,255,255,.88);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:950;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tabs button.active{
      border-color: rgba(91,124,250,.55);
      box-shadow: 0 0 0 3px rgba(91,124,250,.14);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(5,8,24,.40);
    }
    th, td{
      padding: 12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:.92rem;
      color: rgba(255,255,255,.82);
      font-weight:950;
      background: rgba(9,13,35,.45);
    }
    tr:last-child td{border-bottom:none}
    .activity-name{font-weight:950}
    .activity-soft{color:var(--muted2); font-size:.9rem; margin-top:2px}

    .meme{ margin-top: 14px; display:grid; grid-template-columns: 1fr; gap:12px; }
    canvas{
      width:100%;
      height:auto;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(5,8,24,.35);
    }
    .share-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .share-status{
      display:none;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(84,255,167,.25);
      background: rgba(8,30,22,.45);
      color: rgba(190,255,225,.92);
      font-weight:950;
    }
    .disclaimer{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(5,8,24,.35);
      color: rgba(255,255,255,.78);
      line-height:1.35;
      font-size:.95rem;
    }

    .panel{
      display:none;
      margin-top: 12px;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(5,8,24,.42);
      padding: 12px;
    }
    .result-item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(9,13,35,.38);
      border-radius: 14px;
      padding: 10px 10px;
      margin-top:10px;
    }
    .result-item .meta{
      color: var(--muted2);
      font-size: .9rem;
      margin-top: 4px;
      line-height:1.25;
    }

    .hidden{ display:none !important; }

    /* === Cartel ne√≥n ‚Äúasi√°tico‚Äù === */
    .neon-sign{
      position:absolute;
      top: 14px;
      right: 14px;
      width: 190px;
      height: 96px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(12,16,42,.65), rgba(5,8,24,.45));
      backdrop-filter: blur(10px);
      transform: rotate(2deg);
      box-shadow:
        0 10px 28px rgba(0,0,0,.35),
        0 0 18px rgba(255,91,203,.18),
        0 0 22px rgba(91,124,250,.16);
      overflow:hidden;
      pointer-events:none;
    }
    .neon-sign:before{
      content:"";
      position:absolute;
      inset:-40px -40px;
      background:
        radial-gradient(200px 120px at 20% 30%, rgba(255,91,203,.35), transparent 60%),
        radial-gradient(200px 120px at 80% 70%, rgba(91,124,250,.30), transparent 60%);
      filter: blur(10px);
      opacity:.9;
    }
    .neon-sign .frame{
      position:absolute;
      inset:10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
    }
    .neon-sign .jp{
      position:absolute;
      inset: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:6px;
      text-align:center;
      font-weight: 950;
      letter-spacing: .5px;
      text-shadow:
        0 0 6px rgba(255,255,255,.35),
        0 0 14px rgba(255,91,203,.35),
        0 0 18px rgba(91,124,250,.25);
    }
    .neon-sign .jp .big{
      font-size: 28px;
      color: rgba(255,255,255,.92);
    }
    .neon-sign .jp .small{
      font-size: 12px;
      color: rgba(255,255,255,.70);
      font-weight: 900;
    }
    .jp-swap{
      position:relative;
      height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .jp-swap span{
      position:absolute;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .4s ease, transform .4s ease;
      white-space:nowrap;
    }
    .jp-swap span.on{
      opacity:1;
      transform: translateY(0);
    }
    @media (max-width: 540px){
      .neon-sign{ width: 160px; height: 88px; top:12px; right:12px; }
      .neon-sign .jp .big{ font-size: 24px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brandline">
        <div class="pill" data-i18n="header.pill">LoVasASudar.com ¬∑ Calculadora de castigo cal√≥rico</div>
      </div>
      <div class="lang" aria-label="Idioma">
        <button class="lang-btn active" type="button" data-lang="es">ES</button>
        <button class="lang-btn" type="button" data-lang="en">EN</button>
      </div>
    </header>

    <!-- HERO + FORM (alineado) -->
    <section class="card hero" id="mainHero">
      <!-- Neon sign -->
      <div class="neon-sign" aria-hidden="true">
        <div class="frame"></div>
        <div class="jp">
          <div class="jp-swap" id="jpSwap">
            <span class="on">„Éè„É≥„Éê„Éº„Ç¨„Éº</span>
            <span>ÂØøÂè∏</span>
          </div>
          <div class="small">NEON MENU</div>
        </div>
      </div>

      <h1 class="title" data-i18n="header.title">LoVasASudar.com</h1>
      <p class="sub" data-i18n="header.subtitle">
        Mete lo que vas a comer y beber y descubre cu√°nto ejercicio tendr√≠as que hacer para sudarlo. Perfecta para cenas con amigos y noches de copas.
      </p>

      <div class="form-grid" aria-label="Formulario principal">

        <div>
          <label for="foodSelect" data-i18n="food.labelMain">Alimento o bebida</label>
          <select id="foodSelect">
            <option value="0" data-label="‚Äî">‚Äî</option>

            <optgroup label="üçï Comida">
              <option value="850" data-label="Pizza mediana">Pizza mediana (~850 kcal)</option>
              <option value="650" data-label="Hamburguesa">Hamburguesa (~650 kcal)</option>
              <option value="1050" data-label="Kebab completo">Kebab completo (~1050 kcal)</option>
              <option value="520" data-label="Raci√≥n bravas">Raci√≥n bravas (~520 kcal)</option>
              <option value="460" data-label="Bocata calamares">Bocata calamares (~460 kcal)</option>

              <option value="500" data-label="Happy Meal McDonald's">Happy Meal McDonald's (~500 kcal)</option>
              <option value="550" data-label="Big Mac">Big Mac (~550 kcal)</option>
              <option value="510" data-label="Men√∫ mediano McDonald's">Men√∫ mediano McDonald's (~510 kcal)</option>
              <option value="250" data-label="6 Nuggets McDonald's">6 Nuggets McDonald's (~250 kcal)</option>
              <option value="340" data-label="Patatas fritas medianas McDonald's">Patatas medianas McDonald's (~340 kcal)</option>
              <option value="420" data-label="Patatas gajo Burger King">Patatas gajo Burger King (~420 kcal)</option>

              <option value="450" data-label="Porci√≥n pizza queso (1/8 mediana)">Porci√≥n pizza queso (1/8 pizza mediana ~450 kcal)</option>
              <option value="500" data-label="Porci√≥n pizza pepperoni (1/8 mediana)">Porci√≥n pizza pepperoni (1/8 pizza mediana ~500 kcal)</option>
              <option value="3600" data-label="Pizza familiar queso entera">Pizza familiar queso entera (~3600 kcal aprox.)</option>
              <option value="4000" data-label="Pizza familiar pepperoni entera">Pizza familiar pepperoni entera (~4000 kcal aprox.)</option>
              <option value="600" data-label="Lasa√±a bolo√±esa">Lasa√±a bolo√±esa (~600 kcal)</option>
              <option value="700" data-label="Raci√≥n pasta carbonara">Raci√≥n pasta carbonara (~700 kcal)</option>

              <option value="250" data-label="Pincho de tortilla">Pincho de tortilla (~250 kcal)</option>
              <option value="500" data-label="Raci√≥n patatas bravas">Raci√≥n patatas bravas (~500 kcal)</option>
              <option value="350" data-label="3 croquetas de jam√≥n">3 croquetas de jam√≥n (~350 kcal)</option>
              <option value="450" data-label="Bocadillo de jam√≥n serrano">Bocadillo de jam√≥n serrano (~450 kcal)</option>
              <option value="550" data-label="Bocadillo de calamares">Bocadillo de calamares (~550 kcal)</option>

              <option value="280" data-label="Donut cl√°sico">Donut cl√°sico (~280 kcal)</option>
              <option value="220" data-label="Croissant de mantequilla">Croissant de mantequilla (~220 kcal)</option>
              <option value="400" data-label="Palmera de chocolate">Palmera de chocolate (~400 kcal)</option>
              <option value="450" data-label="Brownie de chocolate">Brownie de chocolate (~450 kcal)</option>
              <option value="450" data-label="Muffin de chocolate">Muffin de chocolate (~450 kcal)</option>
              <option value="550" data-label="Tarta de queso porci√≥n">Tarta de queso porci√≥n (~550 kcal)</option>
              <option value="500" data-label="Tarta de chocolate porci√≥n">Tarta de chocolate porci√≥n (~500 kcal)</option>

              <option value="150" data-label="Barrita chocolate tipo KitKat">Barrita chocolate tipo KitKat (~150 kcal)</option>
              <option value="240" data-label="Barrita Snickers">Barrita Snickers (~240 kcal)</option>
              <option value="250" data-label="Bolsa patatas fritas peque√±a">Patatas fritas bolsa peque√±a (~250 kcal)</option>
              <option value="500" data-label="Bolsa patatas fritas grande">Patatas fritas bolsa grande (~500 kcal)</option>
              <option value="200" data-label="Kinder Bueno (2 barritas)">Kinder Bueno (2 barritas) (~200 kcal)</option>
              <option value="200" data-label="Helado de palo cremoso">Helado de palo cremoso (~200 kcal)</option>
              <option value="280" data-label="Helado tipo Magnum">Helado tipo Magnum (~280 kcal)</option>

              <option value="650" data-label="Hamburguesa casera completa">Hamburguesa casera completa (~650 kcal)</option>
              <option value="350" data-label="Raci√≥n de sushi (8 piezas)">Raci√≥n de sushi (8 piezas) (~350 kcal)</option>
              <option value="300" data-label="Ensalada C√©sar completa">Ensalada C√©sar completa (~300 kcal)</option>

              <option value="custom" data-label="Personalizado">Otro / none</option>
            </optgroup>

            <optgroup label="üç∫ Bebida">
              <option value="150" data-label="Cerveza 330 ml">Cerveza 330 ml (~150 kcal)</option>
              <option value="180" data-label="Cerveza artesana 330 ml">Cerveza artesana 330 ml (~180 kcal)</option>
              <option value="90" data-label="Copa vino tinto">Copa vino tinto (~90 kcal)</option>
              <option value="110" data-label="Copa vino blanco">Copa vino blanco (~110 kcal)</option>
              <option value="210" data-label="Gin-tonic">Gin-tonic (~210 kcal)</option>
              <option value="200" data-label="Ron-cola">Ron-cola (~200 kcal)</option>
              <option value="240" data-label="Mojito">Mojito (~240 kcal)</option>

              <option value="230" data-label="Sex on the Beach">Sex on the Beach (~230 kcal)</option>
              <option value="250" data-label="Caipiri√±a">Caipiri√±a (~250 kcal)</option>
              <option value="300" data-label="Pi√±a colada">Pi√±a colada (~300 kcal)</option>
              <option value="200" data-label="Whisky-cola">Whisky-cola (~200 kcal)</option>
              <option value="200" data-label="Aperol Spritz">Aperol Spritz (~200 kcal)</option>
              <option value="65" data-label="Chupito tequila">Chupito de tequila (~65 kcal)</option>
              <option value="120" data-label="Refresco azucarado 330 ml">Refresco azucarado 330 ml (~120 kcal)</option>
              <option value="100" data-label="Verm√∫">Verm√∫ (~100 kcal)</option>
            </optgroup>
          </select>

          <div class="hint">
            <span data-i18n="food.searchHint">¬øNo est√° en la lista? Busca en Open Food Facts (beta).</span>
            <span class="linklike" id="openFoodSearch" data-i18n="food.searchLink">Abrir buscador</span>
          </div>
        </div>

        <div>
          <label for="peso" data-i18n="profile.weightLabel">Peso (kg)</label>
          <input id="peso" type="number" min="30" max="250" step="0.1" placeholder="80" />
          <div class="hint" data-i18n="profile.weightHint">El c√°lculo se hace por kg de peso (ecuaci√≥n basada en MET).</div>
        </div>

        <div>
          <label for="sexo" data-i18n="profile.genderLabel">G√©nero (opcional)</label>
          <select id="sexo">
            <option value="no" data-i18n="gender.opt0">Prefiero no decirlo</option>
            <option value="hombre" data-i18n="gender.optMale">Hombre</option>
            <option value="mujer" data-i18n="gender.optFemale">Mujer</option>
            <option value="otro" data-i18n="gender.optOther">Otro</option>
          </select>
          <div class="hint" data-i18n="profile.genderHint">
            A igualdad de peso, hombres y mujeres suelen quemar algo diferente. Aqu√≠ aplicamos un ajuste sencillo (~5%) para reflejarlo de forma aproximada.
          </div>
        </div>

        <div>
          <label for="unidades" data-i18n="food.unitsLabel">N.¬∫ de unidades</label>
          <input id="unidades" type="number" min="1" step="1" value="1" />
          <div class="hint" data-i18n="food.unitsHint">Ej: 3 cervezas ‚Üí pon 3 unidades.</div>
        </div>

        <div>
          <label for="customKcal" data-i18n="food.extraLabel">Calor√≠as extra</label>
          <input id="customKcal" type="number" min="0" step="1" placeholder="0" />
          <div class="hint" data-i18n="food.extraHint">Se suman a lo anterior (comida + copas).</div>
        </div>

        <div></div>
      </div>

      <div class="microbar" aria-label="Opciones peque√±as">
        <label class="chip" title="Modo noche de copas">
          <input id="toggleDrinks" type="checkbox" />
          <span class="dot"></span>
          <span data-i18n="drinks.toggleTitle">Modo noche de copas</span>
        </label>

        <label class="chip" title="Batalla de colegas">
          <input id="toggleBattle" type="checkbox" />
          <span class="dot"></span>
          <span data-i18n="battle.toggleTitle">Batalla de colegas</span>
        </label>

        <label class="chip" title="Calculadora inversa">
          <input id="toggleInverse" type="checkbox" />
          <span class="dot"></span>
          <span data-i18n="inverse.title">Calculadora inversa (modo precavido)</span>
        </label>

        <label class="chip" title="Ranking local">
          <input id="toggleStats" type="checkbox" />
          <span class="dot"></span>
          <span data-i18n="stats.title">Ranking semanal (an√≥nimo)</span>
        </label>
      </div>

      <button class="btn btn-primary btn-wide" id="btnCalcular" type="button" data-i18n="btn.calculate">
        CALCULAR EJERCICIO NECESARIO üí™
      </button>

      <div class="error" id="errorBox"></div>

      <!-- Open Food Facts panel -->
      <div class="panel" id="foodSearchPanel">
        <div style="display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;">
          <div>
            <div style="font-weight:950" data-i18n="foodSearch.title">Buscador (Open Food Facts)</div>
            <div class="muted" style="margin-top:2px;" data-i18n="foodSearch.subtitle">
              Escribe un producto. Te devolvemos resultados con kcal/100g y puedes a√±adirlo a la lista.
            </div>
          </div>
          <button class="btn btn-secondary" type="button" id="btnFoodSearchClose" data-i18n="foodSearch.close">Cerrar</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label for="foodQuery" data-i18n="foodSearch.queryLabel">Buscar</label>
            <input id="foodQuery" placeholder="pizza pepperoni, cerveza 0,0..." />
            <div class="hint" data-i18n="foodSearch.queryHint">Consejo: a√±ade marca o tipo (‚Äúpizza pepperoni‚Äù, ‚Äúcerveza 0,0‚Äù).</div>
          </div>
          <div>
            <label for="foodServing" data-i18n="foodSearch.servingLabel">Raci√≥n (g/ml)</label>
            <input id="foodServing" type="number" min="0" step="1" placeholder="250" />
            <div class="hint" data-i18n="foodSearch.servingHint">Para convertir kcal/100g a tu raci√≥n.</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn btn-primary" type="button" id="btnFoodSearch" data-i18n="foodSearch.btn">Buscar</button>
          <div class="muted">
            <b data-i18n="foodSearch.disclaimerTitle">Beta:</b>
            <span data-i18n="foodSearch.disclaimerBody">Los datos vienen de un repositorio abierto (usuarios suben productos). Puede haber errores.</span>
          </div>
        </div>

        <div class="share-status" id="foodSearchStatus" style="display:none;margin-top:10px;"></div>
        <div id="foodSearchResults" style="display:none;"></div>
      </div>

      <!-- ADVANCED -->
      <div class="advanced" id="advancedZone">

        <details id="battleDetails" class="acc">
          <summary><span data-i18n="battle.toggleTitle">Batalla de colegas</span> <span class="muted">‚ñº</span></summary>
          <div class="acc-body">
            <div class="muted" style="margin-bottom:10px;" data-i18n="battle.hint">
              Si nadie aqu√≠ tiene peso v√°lido, solo te usamos a ti. Si los rellenas, todos comparten castigo cal√≥rico.
            </div>

            <div class="row">
              <div>
                <label data-i18n="battle.name1" for="friend1Name">Nombre 1</label>
                <input id="friend1Name" placeholder="Alex" />
              </div>
              <div>
                <label data-i18n="battle.weight1" for="friend1Weight">Peso 1 (kg)</label>
                <input id="friend1Weight" type="number" min="30" max="250" step="0.1" placeholder="75" />
              </div>
            </div>

            <div class="row">
              <div>
                <label data-i18n="battle.name2" for="friend2Name">Nombre 2</label>
                <input id="friend2Name" placeholder="Colega 2" />
              </div>
              <div>
                <label data-i18n="battle.weight2" for="friend2Weight">Peso 2 (kg)</label>
                <input id="friend2Weight" type="number" min="30" max="250" step="0.1" placeholder="85" />
              </div>
            </div>

            <div class="row">
              <div>
                <label data-i18n="battle.name3" for="friend3Name">Nombre 3</label>
                <input id="friend3Name" placeholder="Colega 3" />
              </div>
              <div>
                <label data-i18n="battle.weight3" for="friend3Weight">Peso 3 (kg)</label>
                <input id="friend3Weight" type="number" min="30" max="250" step="0.1" placeholder="68" />
              </div>
            </div>
          </div>
        </details>

        <details id="drinksDetails" class="acc">
          <summary><span data-i18n="drinks.toggleTitle">Modo noche de copas</span> <span class="muted">‚ñº</span></summary>
          <div class="acc-body">
            <div class="muted" style="margin-bottom:10px;" data-i18n="drinks.hint">
              Perfecto para ver cu√°nto ‚Äúvale‚Äù tu noche de copas adem√°s de la cena.
            </div>

            <div class="row">
              <div>
                <label for="drinkSelect" data-i18n="drinks.drinkLabel">Bebida</label>
                <select id="drinkSelect">
                  <option value="150" data-label="Cerveza 330 ml">Cerveza 330 ml (~150 kcal)</option>
                  <option value="180" data-label="Cerveza artesana 330 ml">Cerveza artesana 330 ml (~180 kcal)</option>
                  <option value="90" data-label="Copa vino tinto">Copa vino tinto (~90 kcal)</option>
                  <option value="110" data-label="Copa vino blanco">Copa vino blanco (~110 kcal)</option>
                  <option value="210" data-label="Gin-tonic">Gin-tonic est√°ndar (~210 kcal)</option>
                  <option value="200" data-label="Ron-cola">Ron-cola (~200 kcal)</option>
                  <option value="240" data-label="Mojito">Mojito (~240 kcal)</option>
                  <option value="230" data-label="Sex on the Beach">Sex on the Beach (~230 kcal)</option>
                  <option value="250" data-label="Caipiri√±a">Caipiri√±a (~250 kcal)</option>
                  <option value="300" data-label="Pi√±a colada">Pi√±a colada (~300 kcal)</option>
                  <option value="200" data-label="Whisky-cola">Whisky-cola (~200 kcal)</option>
                  <option value="200" data-label="Aperol Spritz">Aperol Spritz (~200 kcal)</option>
                  <option value="65" data-label="Chupito tequila">Chupito de tequila (~65 kcal)</option>
                  <option value="120" data-label="Refresco azucarado 330 ml">Refresco azucarado 330 ml (~120 kcal)</option>
                  <option value="100" data-label="Verm√∫">Verm√∫ (~100 kcal)</option>
                </select>
                <div class="hint" data-i18n="drinks.chipText">Estas calor√≠as se suman al resto.</div>
              </div>
              <div>
                <label for="numCopas" data-i18n="drinks.numLabel">N.¬∫ de copas</label>
                <input id="numCopas" type="number" min="0" step="1" value="0" />
              </div>
            </div>
          </div>
        </details>

        <details id="inverseDetails" class="acc">
          <summary><span data-i18n="inverse.title">Calculadora inversa (modo precavido)</span> <span class="muted">‚ñº</span></summary>
          <div class="acc-body" id="inverseBlock">
            <div class="row">
              <div>
                <label for="invKm" data-i18n="inverse.kmLabel">Ma√±ana corro (km)</label>
                <input id="invKm" type="number" min="0" step="0.1" placeholder="10" />
                <div class="hint" data-i18n="inverse.kmHint">Regla r√°pida: correr ‚âà 1 kcal por kg por km (aprox).</div>
              </div>
              <div>
                <label for="invIntensity" data-i18n="inverse.intensityLabel">Intensidad</label>
                <select id="invIntensity">
                  <option value="0.9" data-i18n="inverse.intensityEasy">Suave</option>
                  <option value="1.0" selected data-i18n="inverse.intensityMid">Media</option>
                  <option value="1.15" data-i18n="inverse.intensityHard">Fuerte</option>
                </select>
                <div class="hint" data-i18n="inverse.intensityHint">Ajuste simple: +/‚àí seg√∫n intensidad.</div>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="invDrink" data-i18n="inverse.drinkLabel">¬øEn qu√© ‚Äúte lo quieres gastar‚Äù?</label>
                <select id="invDrink">
                  <option value="0" data-label="‚Äî">‚Äî</option>
                  <optgroup label="üçï Comida">
                    <option value="850" data-label="Pizza mediana">Pizza mediana (~850 kcal)</option>
                    <option value="650" data-label="Hamburguesa">Hamburguesa (~650 kcal)</option>
                    <option value="350" data-label="Raci√≥n de sushi (8 piezas)">Raci√≥n de sushi (8 piezas) (~350 kcal)</option>
                    <option value="1050" data-label="Kebab completo">Kebab completo (~1050 kcal)</option>
                    <option value="custom" data-label="Personalizado">Otro / none</option>
                  </optgroup>
                  <optgroup label="üç∫ Bebida">
                    <option value="150" data-label="Cerveza 330 ml">Cerveza 330 ml (~150 kcal)</option>
                    <option value="210" data-label="Gin-tonic">Gin-tonic (~210 kcal)</option>
                    <option value="240" data-label="Mojito">Mojito (~240 kcal)</option>
                  </optgroup>
                </select>
              </div>
              <div>
                <label for="invExtraMargin" data-i18n="inverse.marginLabel">Margen ‚Äúpor si acaso‚Äù</label>
                <select id="invExtraMargin">
                  <option value="0.85" data-i18n="inverse.marginHigh">Alto (85%)</option>
                  <option value="0.70" selected data-i18n="inverse.marginMid">Medio (70%)</option>
                  <option value="0.55" data-i18n="inverse.marginLow">Bajo (55%)</option>
                </select>
                <div class="hint" data-i18n="inverse.marginHint">Porque luego hay cena. Y postre. Y ‚Äúuna √∫ltima‚Äù.</div>
              </div>
            </div>

            <button class="btn btn-primary btn-wide" type="button" id="btnInverse" data-i18n="inverse.btn">¬øCu√°nto puedo beber?</button>
            <div class="panel" id="inverseOut" style="display:none;"></div>
          </div>
        </details>

        <details id="statsDetails" class="acc">
          <summary><span data-i18n="stats.title">Ranking semanal (an√≥nimo)</span> <span class="muted">‚ñº</span></summary>
          <div class="acc-body">
            <div class="muted" data-i18n="stats.noteBody">
              Este ranking es <strong>local en tu dispositivo</strong> (sirve para ‚Äúpicar‚Äù a tus colegas).
            </div>

            <div class="row" style="margin-top:10px;">
              <div class="card" style="padding:12px; background:rgba(5,8,24,.35)">
                <div class="muted" data-i18n="stats.weekKcalLabel">Kcal acumuladas (7 d√≠as)</div>
                <div style="font-size:1.6rem; font-weight:950; margin-top:4px;"><span id="weekKcal">0</span></div>
              </div>
              <div class="card" style="padding:12px; background:rgba(5,8,24,.35)">
                <div class="muted" data-i18n="stats.weekKmLabel">Km ‚Äúculpa de la fiesta‚Äù (7 d√≠as)</div>
                <div style="font-size:1.6rem; font-weight:950; margin-top:4px;"><span id="weekKm">0</span></div>
              </div>
            </div>

            <div class="card" style="padding:12px; background:rgba(5,8,24,.35); margin-top:10px;">
              <div class="muted" data-i18n="stats.yearTopLabel">Top castigo (este a√±o)</div>
              <div style="font-weight:950; margin-top:6px;"><span id="yearTop">‚Äî</span></div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
              <button class="btn btn-secondary" id="btnResetStats" type="button" data-i18n="stats.reset">Resetear stats (local)</button>
              <button class="btn btn-primary" id="btnShareStats" type="button" data-i18n="stats.share">Compartir mi ‚Äúranking‚Äù</button>
            </div>

            <div class="share-status" id="statsHeadline" style="display:none;margin-top:10px;"></div>
          </div>
        </details>

      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="card" id="resultsSection" style="margin-top:16px;">
      <div class="results-head">
        <h2 style="margin:0; font-size:1.25rem; font-weight:950;">üéØ <span data-i18n="results.title">Resultados del castigo cal√≥rico</span></h2>
        <span class="badge kcal" id="kcalBadge">0 kcal</span>
      </div>

      <div class="phrase" id="phraseBox" data-i18n="phrase.initial">
        Introduce tu peso, elige comida o bebida, y pulsa en <strong>‚ÄúCalcular ejercicio necesario‚Äù</strong>.
      </div>

      <div class="tabs" id="peopleTabs"></div>

      <div id="tableWrapper" style="display:none;">
        <table>
          <thead>
            <tr>
              <th data-i18n="table.activity">Actividad</th>
              <th data-i18n="table.time">Tiempo aprox.</th>
              <th data-i18n="table.distance">Distancia aprox.</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>

      <div class="meme">
        <canvas id="memeCanvas" width="1200" height="630" aria-label="Meme generado"></canvas>

        <div class="share-row">
          <button class="btn btn-primary" type="button" id="btnShare" data-i18n="share.btnShare">Compartir</button>
          <button class="btn btn-secondary" type="button" id="btnGenMeme" data-i18n="share.btnGen">Generar meme</button>
          <button class="btn btn-secondary" type="button" id="btnDownload" data-i18n="share.btnDownload">Descargar imagen</button>
          <button class="btn btn-secondary" type="button" id="btnCopyText" data-i18n="share.btnCopy">Copiar texto</button>
          <button class="btn btn-secondary" type="button" id="btnEdit" aria-label="Editar entrada">Editar</button>
          <div class="share-status" id="shareStatus"></div>
        </div>
      </div>

      <div class="disclaimer" id="disclaimer"></div>
    </section>
  </div>

  <script>
    // --- Idioma actual ---
    let currentLang = 'es';

    // --- GA4 helper ---
    function gaEvent(name, params = {}) {
      try { if (window.gtag) window.gtag('event', name, params); } catch (e) {}
    }

    // === Neon JP swap (hamburguesa <-> sushi) ===
    (function neonSwap(){
      const el = document.getElementById('jpSwap');
      if (!el) return;
      const spans = el.querySelectorAll('span');
      if (spans.length < 2) return;
      let i = 0;
      setInterval(()=>{
        spans[i].classList.remove('on');
        i = (i + 1) % spans.length;
        spans[i].classList.add('on');
      }, 2400);
    })();

    // -------- I18N --------
    const I18N = {
      es: {
        'doc.title': 'LoVasASudar.com ‚Äì Calculadora de castigo cal√≥rico de fiesta',
        'header.pill': 'LoVasASudar.com ¬∑ Calculadora de castigo cal√≥rico',
        'header.title': 'LoVasASudar.com',
        'header.subtitle': 'Mete lo que vas a comer y beber y descubre cu√°nto ejercicio tendr√≠as que hacer para sudarlo. Perfecta para cenas con amigos y noches de copas.',

        'profile.weightLabel': 'Peso (kg)',
        'profile.weightHint': 'El c√°lculo se hace por kg de peso (ecuaci√≥n basada en MET).',
        'profile.genderLabel': 'G√©nero (opcional)',
        'profile.genderHint': 'A igualdad de peso, hombres y mujeres suelen quemar algo diferente. Aqu√≠ aplicamos un ajuste sencillo (~5%) para reflejarlo de forma aproximada.',

        'food.labelMain': 'Alimento o bebida',
        'food.unitsLabel': 'N.¬∫ de unidades',
        'food.unitsHint': 'Ej: 3 cervezas ‚Üí pon 3 unidades.',
        'food.extraLabel': 'Calor√≠as extra',
        'food.extraHint': 'Se suman a lo anterior (comida + copas).',
        'food.searchHint': '¬øNo est√° en la lista? Busca en Open Food Facts (beta).',
        'food.searchLink': 'Abrir buscador',

        'foodSearch.title': 'Buscador (Open Food Facts)',
        'foodSearch.subtitle': 'Escribe un producto. Te devolvemos resultados con kcal/100g y puedes a√±adirlo a la lista.',
        'foodSearch.queryLabel': 'Buscar',
        'foodSearch.queryHint': 'Consejo: a√±ade marca o tipo (‚Äúpizza pepperoni‚Äù, ‚Äúcerveza 0,0‚Äù).',
        'foodSearch.servingLabel': 'Raci√≥n (g/ml)',
        'foodSearch.servingHint': 'Para convertir kcal/100g a tu raci√≥n.',
        'foodSearch.btn': 'Buscar',
        'foodSearch.close': 'Cerrar',
        'foodSearch.disclaimerTitle': 'Beta:',
        'foodSearch.disclaimerBody': 'Los datos vienen de un repositorio abierto (usuarios suben productos). Puede haber errores.',

        'btn.calculate': 'CALCULAR EJERCICIO NECESARIO üí™',

        'results.title': 'Resultados del castigo cal√≥rico',
        'table.activity': 'Actividad',
        'table.time': 'Tiempo aprox.',
        'table.distance': 'Distancia aprox.',

        'share.btnGen': 'Generar meme',
        'share.btnShare': 'Compartir',
        'share.btnDownload': 'Descargar imagen',
        'share.btnCopy': 'Copiar texto',

        'battle.toggleTitle': 'Batalla de colegas',
        'battle.hint': 'Si nadie aqu√≠ tiene peso v√°lido, solo te usamos a ti. Si los rellenas, todos comparten castigo cal√≥rico.',
        'battle.name1': 'Nombre 1',
        'battle.weight1': 'Peso 1 (kg)',
        'battle.name2': 'Nombre 2',
        'battle.weight2': 'Peso 2 (kg)',
        'battle.name3': 'Nombre 3',
        'battle.weight3': 'Peso 3 (kg)',

        'drinks.toggleTitle': 'Modo noche de copas',
        'drinks.drinkLabel': 'Bebida',
        'drinks.numLabel': 'N.¬∫ de copas',
        'drinks.chipText': 'Estas calor√≠as se suman al resto.',
        'drinks.hint': 'Perfecto para ver cu√°nto ‚Äúvale‚Äù tu noche de copas adem√°s de la cena.',

        'inverse.title': 'Calculadora inversa (modo precavido)',
        'inverse.kmLabel': 'Ma√±ana corro (km)',
        'inverse.kmHint': 'Regla r√°pida: correr ‚âà 1 kcal por kg por km (aprox).',
        'inverse.intensityLabel': 'Intensidad',
        'inverse.intensityEasy': 'Suave',
        'inverse.intensityMid': 'Media',
        'inverse.intensityHard': 'Fuerte',
        'inverse.intensityHint': 'Ajuste simple: +/‚àí seg√∫n intensidad.',
        'inverse.drinkLabel': '¬øEn qu√© ‚Äúte lo quieres gastar‚Äù?',
        'inverse.marginLabel': 'Margen ‚Äúpor si acaso‚Äù',
        'inverse.marginHigh': 'Alto (85%)',
        'inverse.marginMid': 'Medio (70%)',
        'inverse.marginLow': 'Bajo (55%)',
        'inverse.marginHint': 'Porque luego hay cena. Y postre. Y ‚Äúuna √∫ltima‚Äù.',
        'inverse.btn': '¬øCu√°nto puedo beber?',

        'stats.title': 'Ranking semanal (an√≥nimo)',
        'stats.noteBody': 'Este ranking es <strong>local en tu dispositivo</strong> (sirve para ‚Äúpicar‚Äù a tus colegas).',
        'stats.weekKcalLabel': 'Kcal acumuladas (7 d√≠as)',
        'stats.weekKmLabel': 'Km ‚Äúculpa de la fiesta‚Äù (7 d√≠as)',
        'stats.yearTopLabel': 'Top castigo (este a√±o)',
        'stats.reset': 'Resetear stats (local)',
        'stats.share': 'Compartir mi ‚Äúranking‚Äù',

        'phrase.initial': 'Introduce tu peso, elige comida o bebida, y pulsa en <strong>‚ÄúCalcular ejercicio necesario‚Äù</strong>.',
        'disclaimer': '<strong>Nota seria dentro de la broma:</strong> los c√°lculos usan una f√≥rmula est√°ndar basada en MET (equivalentes metab√≥licos) multiplicada por tu peso y un peque√±o ajuste por g√©nero cuando se indica. Son aproximaciones para concienciar y divertir, no prescripci√≥n m√©dica.',
        'gender.opt0': 'Prefiero no decirlo',
        'gender.optMale': 'Hombre',
        'gender.optFemale': 'Mujer',
        'gender.optOther': 'Otro'
      },
      en: {
        'doc.title': 'LoVasASudar.com ‚Äì Party calorie punishment calculator',
        'header.pill': 'LoVasASudar.com ¬∑ Calorie punishment calculator',
        'header.title': 'LoVasASudar.com',
        'header.subtitle': 'Enter what you are going to eat and drink and see how much exercise you would need to sweat it out. Perfect for dinners with friends and party nights.',

        'profile.weightLabel': 'Weight (kg)',
        'profile.weightHint': 'The calculation uses your weight in kg (MET-based equation).',
        'profile.genderLabel': 'Gender (optional)',
        'profile.genderHint': 'For the same weight, men and women often burn slightly different amounts. We apply a simple (~5%) adjustment to reflect that roughly.',

        'food.labelMain': 'Food or drink',
        'food.unitsLabel': 'Number of units',
        'food.unitsHint': 'Example: 3 beers ‚Üí enter 3 units.',
        'food.extraLabel': 'Extra calories',
        'food.extraHint': 'These are added on top (food + drinks).',
        'food.searchHint': 'Not on the list? Search Open Food Facts (beta).',
        'food.searchLink': 'Open search',

        'foodSearch.title': 'Search (Open Food Facts)',
        'foodSearch.subtitle': 'Type a product. We show kcal/100g and you can add it to the list.',
        'foodSearch.queryLabel': 'Search',
        'foodSearch.queryHint': 'Tip: add brand/type (‚Äúpepperoni pizza‚Äù, ‚Äú0.0 beer‚Äù).',
        'foodSearch.servingLabel': 'Serving (g/ml)',
        'foodSearch.servingHint': 'Convert kcal/100g to your serving.',
        'foodSearch.btn': 'Search',
        'foodSearch.close': 'Close',
        'foodSearch.disclaimerTitle': 'Beta:',
        'foodSearch.disclaimerBody': 'Data comes from an open repository (user-submitted products). Errors may exist.',

        'btn.calculate': 'CALCULATE REQUIRED EXERCISE üí™',

        'results.title': 'Calorie punishment results',
        'table.activity': 'Activity',
        'table.time': 'Approx. time',
        'table.distance': 'Approx. distance',

        'share.btnGen': 'Generate meme',
        'share.btnShare': 'Share',
        'share.btnDownload': 'Download image',
        'share.btnCopy': 'Copy text',

        'battle.toggleTitle': 'Friends battle',
        'battle.hint': 'If no valid weight is set here, only you are used. If you fill them, everyone shares the calorie punishment.',
        'battle.name1': 'Name 1',
        'battle.weight1': 'Weight 1 (kg)',
        'battle.name2': 'Name 2',
        'battle.weight2': 'Weight 2 (kg)',
        'battle.name3': 'Name 3',
        'battle.weight3': 'Weight 3 (kg)',

        'drinks.toggleTitle': 'Night drinks mode',
        'drinks.drinkLabel': 'Drink',
        'drinks.numLabel': 'Number of drinks',
        'drinks.chipText': 'These calories are added to the total.',
        'drinks.hint': 'Perfect to see how much your drinks ‚Äúcost‚Äù on top of dinner.',

        'inverse.title': 'Inverse calculator (cautious mode)',
        'inverse.kmLabel': 'Tomorrow I run (km)',
        'inverse.kmHint': 'Quick rule: running ‚âà 1 kcal per kg per km (rough).',
        'inverse.intensityLabel': 'Intensity',
        'inverse.intensityEasy': 'Easy',
        'inverse.intensityMid': 'Medium',
        'inverse.intensityHard': 'Hard',
        'inverse.intensityHint': 'Simple adjustment by intensity.',
        'inverse.drinkLabel': 'Spend it on‚Ä¶',
        'inverse.marginLabel': 'Safety margin',
        'inverse.marginHigh': 'High (85%)',
        'inverse.marginMid': 'Medium (70%)',
        'inverse.marginLow': 'Low (55%)',
        'inverse.marginHint': 'Because dinner happens. And dessert. And ‚Äúone last one‚Äù.',
        'inverse.btn': 'How much can I drink?',

        'stats.title': 'Weekly ranking (anonymous)',
        'stats.noteBody': 'This ranking is <strong>local on your device</strong> (good for viral ‚Äúchallenge‚Äù vibes).',
        'stats.weekKcalLabel': 'Calories accumulated (7 days)',
        'stats.weekKmLabel': '‚ÄúParty guilt‚Äù km (7 days)',
        'stats.yearTopLabel': 'Top punishment (this year)',
        'stats.reset': 'Reset stats (local)',
        'stats.share': 'Share my ‚Äúranking‚Äù',

        'phrase.initial': 'Enter your weight, choose food or drinks and click <strong>‚ÄúCalculate required exercise‚Äù</strong>.',
        'disclaimer': '<strong>Serious note behind the joke:</strong> calculations use a standard MET-based formula multiplied by your weight, plus a small gender adjustment when given. These are rough estimates for awareness and fun, not medical advice.',
        'gender.opt0': 'Prefer not to say',
        'gender.optMale': 'Male',
        'gender.optFemale': 'Female',
        'gender.optOther': 'Other'
      }
    };

    const MESSAGES = {
      es: {
        errorUnits: 'Introduce un n√∫mero de unidades v√°lido (m√≠nimo 1).',
        errorWeight: 'Introduce tu peso en kg (entre 30 y 250 kg).',
        errorNoKcal: 'Necesitamos al menos alguna calor√≠a (comida, copas o extra) para calcular.',
        errorDrinksInvalid: 'Para el modo copas, elige una bebida y un n√∫mero de copas v√°lidos.',
        errorInverseKm: 'Introduce kil√≥metros v√°lidos (por ejemplo 10).',
        errorInverseNeedWeight: 'Para la inversa, necesitamos tu peso arriba.',
        copied: 'Copiado ‚úÖ',
        shareFail: 'Tu navegador no deja compartir archivo directamente. Descarga la imagen y comp√°rtela desde WhatsApp/Instagram.',
        memeNeedCalc: 'Primero calcula un castigo (arriba). Luego generamos el meme.',
        offEmpty: 'No encontr√© kcal en ese producto (o no ven√≠an). Prueba otro resultado o usa calor√≠as manuales.'
      },
      en: {
        errorUnits: 'Enter a valid number of units (minimum 1).',
        errorWeight: 'Enter your weight in kg (between 30 and 250 kg).',
        errorNoKcal: 'We need at least some calories (food, drinks or extra) to calculate.',
        errorDrinksInvalid: 'For drinks mode, choose a drink and a valid number of drinks.',
        errorInverseKm: 'Enter valid km (e.g., 10).',
        errorInverseNeedWeight: 'For inverse mode, we need your weight above.',
        copied: 'Copied ‚úÖ',
        shareFail: 'Your browser can‚Äôt share the image file directly. Download it and share via WhatsApp/Instagram.',
        memeNeedCalc: 'Calculate a punishment first. Then we generate the meme.',
        offEmpty: 'No kcal were found for that product. Try another result or enter calories manually.'
      }
    };

    const PHRASES = {
      es: [
        (k, l) => `Tu elecci√≥n (${l}) son aproximadamente ${k} kcal. No es pecado, pero el cuerpo te lo va a cobrar en sudor.`,
        (k, l) => `Eso que vas a tomar (${l}) equivale a una negociaci√≥n con tu cuerpo: ${k} kcal en la mesa, a cambio de deporte despu√©s.`,
        (k, l) => `Si las calor√≠as fuesen una moneda, ${l} te est√° saliendo caro: ${k} monedas de sudor.`,
        (k, l) => `Buenas noticias: ${l} no es eterno. Malas noticias: las ${k} kcal tampoco desaparecen solas.`,
        (k, l) => `Tu ${l} es b√°sicamente un ‚Äúpr√©stamo‚Äù de ${k} kcal. Aqu√≠ tienes el plan de devoluci√≥n.`
      ],
      en: [
        (k, l) => `Your choice (${l}) is roughly ${k} kcal. Not a crime, but your body will charge interest in sweat.`,
        (k, l) => `What you're having (${l}) is a negotiation with your body: ${k} kcal now, exercise later.`,
        (k, l) => `If calories were a currency, ${l} is pricey: ${k} sweat coins.`,
        (k, l) => `Good news: ${l} won‚Äôt last forever. Bad news: those ${k} kcal won‚Äôt vanish by themselves.`,
        (k, l) => `Your ${l} is basically a ‚Äúloan‚Äù of ${k} kcal. Here‚Äôs the repayment plan.`
      ]
    };

    const ACTIVITIES = [
      { id: 'correr', name: { es: 'Correr', en: 'Running' }, met: 8.5, hasDistance: true, speed: 8, note: { es: 'trote alegre ~8 km/h', en: 'easy run ~8 km/h' } },
      { id: 'andar', name: { es: 'Andar r√°pido', en: 'Brisk walking' }, met: 3.8, hasDistance: true, speed: 5.5, note: { es: 'paseo ligero ~5,5 km/h', en: 'light walk ~5.5 km/h' } },
      { id: 'bailar', name: { es: 'Bailar', en: 'Dancing' }, met: 6, hasDistance: false, note: { es: 'discoteca / ‚ÄúManiac‚Äù vibes', en: 'club dancing / ‚ÄúManiac‚Äù vibes' } },
      { id: 'futbol', name: { es: 'F√∫tbol', en: 'Football / Soccer' }, met: 7, hasDistance: false, note: { es: 'partido informal con colegas', en: 'casual match with friends' } },
      { id: 'musculacion', name: { es: 'Musculaci√≥n (gym)', en: 'Weight training (gym)' }, met: 6, hasDistance: false, note: { es: 'entreno serio, no selfies', en: 'serious workout, not selfies' } },
      { id: 'spinning', name: { es: 'Spinning', en: 'Spinning' }, met: 9, hasDistance: false, note: { es: 'clase de bici indoor a tope', en: 'intense indoor cycling class' } },
      { id: 'bici_exterior', name: { es: 'Bicicleta exterior', en: 'Outdoor cycling' }, met: 7, hasDistance: true, speed: 18, note: { es: 'bici urbana / paseo r√°pido', en: 'urban / fast leisure cycling' } },
      { id: 'nadar', name: { es: 'Nadar', en: 'Swimming' }, met: 6.5, hasDistance: false, note: { es: 'crol moderado', en: 'moderate freestyle' } },
      { id: 'padel', name: { es: 'P√°del', en: 'Padel' }, met: 7, hasDistance: false, note: { es: 'partido dobles', en: 'doubles match' } },
      { id: 'tenis', name: { es: 'Tenis', en: 'Tennis' }, met: 7.3, hasDistance: false, note: { es: 'partido recreativo', en: 'recreational match' } },
      { id: 'petanca', name: { es: 'Petanca', en: 'P√©tanque / boules' }, met: 2.5, hasDistance: false, note: { es: 's√≠, tambi√©n cuenta üòÑ', en: 'yes, this counts too üòÑ' } },
      { id: 'dardos', name: { es: 'Dardos', en: 'Darts' }, met: 2, hasDistance: false, note: { es: 'ideal para la noche de copas', en: 'perfect during a night out' } }
    ];

    let currentResults = { people: [], kcal: 0, label: '' };
    let activePersonIndex = 0;

    const LS_STATS_KEY = 'lvas_stats_v1';
    const LS_PICKED_FOODS_KEY = 'lvas_picked_foods_v1';

    function nowMs() { return Date.now(); }
    function thisYear() { return new Date().getFullYear(); }
    function safeParse(json, fallback) { try { return JSON.parse(json); } catch { return fallback; } }

    function getStats() {
      const raw = localStorage.getItem(LS_STATS_KEY);
      const base = safeParse(raw, null);
      if (base && typeof base === 'object') return base;
      return { events: [] };
    }
    function saveStats(stats) { localStorage.setItem(LS_STATS_KEY, JSON.stringify(stats)); }
    function addEventToStats(kcal, label) {
      const stats = getStats();
      stats.events = Array.isArray(stats.events) ? stats.events : [];
      stats.events.push({ ts: nowMs(), kcal: Math.max(0, Math.round(kcal)), label: (label || '').slice(0, 120) });
      if (stats.events.length > 600) stats.events = stats.events.slice(stats.events.length - 600);
      saveStats(stats);
      renderStatsUI();
    }
    function getEventsLastDays(days) {
      const cutoff = nowMs() - days * 24 * 60 * 60 * 1000;
      const stats = getStats();
      return (stats.events || []).filter(e => e && typeof e.ts === 'number' && e.ts >= cutoff);
    }
    function getYearEvents(year) {
      const stats = getStats();
      return (stats.events || []).filter(e => new Date(e.ts).getFullYear() === year);
    }
    function sumKcal(events) { return events.reduce((a, e) => a + (Number(e.kcal) || 0), 0); }
    function getTopEvent(events) {
      let top = null;
      for (const e of events) if (!top || (Number(e.kcal)||0) > (Number(top.kcal)||0)) top = e;
      return top;
    }

    function getPickedFoods() {
      const raw = localStorage.getItem(LS_PICKED_FOODS_KEY);
      const base = safeParse(raw, []);
      return Array.isArray(base) ? base : [];
    }
    function savePickedFoods(arr) {
      localStorage.setItem(LS_PICKED_FOODS_KEY, JSON.stringify(arr.slice(0, 120)));
    }

    function tMsg(code) { return (MESSAGES[currentLang] && MESSAGES[currentLang][code]) || code; }
    function randomPhrase(kcal, label) {
      const arr = PHRASES[currentLang] || PHRASES.es;
      const idx = Math.floor(Math.random() * arr.length);
      return arr[idx](kcal, label || (currentLang === 'en' ? 'your choice' : 'tu elecci√≥n'));
    }

    function formatMinutes(mins) {
      if (mins < 1) return currentLang === 'en' ? 'less than 1 min' : 'menos de 1 min';
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      if (h === 0) return `${m} min`;
      if (m === 0) return `${h} h`;
      return `${h} h ${m} min`;
    }
    function formatDistance(km) {
      if (!km || km <= 0.05) return '‚Äî';
      if (km < 1) return `${(km * 1000).toFixed(0)} m`;
      if (km < 10) return `${km.toFixed(1)} km`;
      return `${km.toFixed(1)} km`;
    }

    function showError(msg){
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
      gaEvent('ui_error', { msg: (msg||'').slice(0,120) });
    }
    function clearError(){
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    }
    function toast(el, msg){
      el.textContent = msg;
      el.style.display = 'inline-flex';
      setTimeout(()=>{ el.style.display='none'; }, 2200);
    }

    function applyI18n(){
      document.documentElement.lang = currentLang;
      document.title = I18N[currentLang]['doc.title'] || document.title;

      document.querySelectorAll('[data-i18n]').forEach(node=>{
        const key = node.getAttribute('data-i18n');
        const val = I18N[currentLang] && I18N[currentLang][key];
        if (!val) return;
        node.innerHTML = val;
      });

      disclaimerEl.innerHTML = I18N[currentLang].disclaimer || '';
      langButtons.forEach(b=> b.classList.toggle('active', b.dataset.lang === currentLang));

      renderPeopleTabs();
      if (currentResults.people && currentResults.people.length){
        renderResultsForPerson(activePersonIndex);
      } else {
        drawMemePlaceholder();
      }
    }

    function genderFactor(sexo){
      if (sexo === 'mujer') return 0.95;
      if (sexo === 'hombre') return 1.00;
      return 0.98;
    }
    function caloriesPerMinute(met, weightKg, sexo){
      const base = (met * 3.5 * weightKg) / 200;
      return base * genderFactor(sexo);
    }
    function calcMinutesForKcal(kcal, met, weightKg, sexo){
      const kpm = caloriesPerMinute(met, weightKg, sexo);
      if (kpm <= 0.0001) return Infinity;
      return kcal / kpm;
    }

    function parseNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }
    function getSelectedFoodLabel(selectEl){
      const opt = selectEl.options[selectEl.selectedIndex];
      if (!opt) return currentLang === 'en' ? 'your choice' : 'tu elecci√≥n';
      return opt.getAttribute('data-label') || opt.textContent.trim();
    }

    function computeTotalKcal(){
      const units = parseNumber(unidadesInput.value);
      if (!Number.isFinite(units) || units < 1) { showError(tMsg('errorUnits')); return null; }

      const weight = parseNumber(pesoInput.value);
      if (!Number.isFinite(weight) || weight < 30 || weight > 250) { showError(tMsg('errorWeight')); return null; }

      const sexo = sexoSelect.value || 'no';

      const selected = foodSelect.value;
      let foodKcal = 0;
      if (selected === 'custom') foodKcal = 0;
      else {
        foodKcal = parseNumber(selected);
        if (!Number.isFinite(foodKcal)) foodKcal = 0;
      }

      const extraKcal = Math.max(0, parseNumber(customKcalInp.value) || 0);

      let drinksKcal = 0;
      if (toggleDrinks.checked) {
        const dk = parseNumber(drinkSelect.value);
        const dc = parseNumber(numCopasInput.value);
        if (!Number.isFinite(dk) || !Number.isFinite(dc) || dc < 0) { showError(tMsg('errorDrinksInvalid')); return null; }
        drinksKcal = dk * dc;
      }

      const total = (foodKcal * units) + extraKcal + drinksKcal;
      if (!(total > 0)) { showError(tMsg('errorNoKcal')); return null; }

      return { totalKcal: total, label: getSelectedFoodLabel(foodSelect), weightKg: weight, sexo };
    }

    function getBattlePeopleOrSolo(main){
      if (!toggleBattle.checked) return [{ name: (currentLang==='en'?'You':'T√∫'), weightKg: main.weightKg, sexo: main.sexo }];
      const people = [{ name: (currentLang==='en'?'You':'T√∫'), weightKg: main.weightKg, sexo: main.sexo }];

      const addFriend = (nameEl, wEl) => {
        const w = parseNumber(wEl.value);
        if (Number.isFinite(w) && w >= 30 && w <= 250) {
          const nm = (nameEl.value || '').trim() || (currentLang==='en'?'Friend':'Colega');
          people.push({ name: nm.slice(0, 18), weightKg: w, sexo: 'no' });
        }
      };
      addFriend(friend1Name, friend1Weight);
      addFriend(friend2Name, friend2Weight);
      addFriend(friend3Name, friend3Weight);
      return people;
    }

    function buildResultsRows(kcal, person){
      const rows = [];
      for (const a of ACTIVITIES){
        const mins = calcMinutesForKcal(kcal, a.met, person.weightKg, person.sexo);
        const dist = a.hasDistance ? (a.speed * (mins / 60)) : null;
        rows.push({
          id: a.id,
          name: a.name[currentLang] || a.name.es,
          note: a.note[currentLang] || a.note.es,
          mins,
          dist
        });
      }
      rows.sort((x,y)=>x.mins - y.mins);
      return rows;
    }

    function renderPeopleTabs(){
      if (!currentResults.people || currentResults.people.length <= 1){
        peopleTabs.style.display = 'none';
        peopleTabs.innerHTML = '';
        return;
      }
      peopleTabs.style.display = 'flex';
      peopleTabs.innerHTML = '';
      currentResults.people.forEach((p, idx)=>{
        const b = document.createElement('button');
        b.type = 'button';
        b.className = (idx === activePersonIndex) ? 'active' : '';
        b.textContent = p.name;
        b.addEventListener('click', ()=>{
          activePersonIndex = idx;
          renderPeopleTabs();
          renderResultsForPerson(idx);
          gaEvent('switch_person', { idx });
        });
        peopleTabs.appendChild(b);
      });
    }

    function renderResultsForPerson(idx){
      if (!currentResults.people || !currentResults.people[idx]) return;
      const person = currentResults.people[idx];
      const kcal = currentResults.kcal;

      phraseBox.innerHTML = randomPhrase(Math.round(kcal), currentResults.label);
      kcalBadge.textContent = `${Math.round(kcal)} kcal`;
      kcalBadge.style.display = 'inline-flex';

      const rows = buildResultsRows(kcal, person);
      resultsBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');

        const tdA = document.createElement('td');
        tdA.innerHTML = `<div class="activity-name">${r.name}</div><div class="activity-soft">${r.note}</div>`;

        const tdT = document.createElement('td');
        tdT.textContent = formatMinutes(r.mins);

        const tdD = document.createElement('td');
        tdD.textContent = r.dist ? formatDistance(r.dist) : '‚Äî';

        tr.appendChild(tdA);
        tr.appendChild(tdT);
        tr.appendChild(tdD);
        resultsBody.appendChild(tr);
      });

      tableWrapper.style.display = 'block';
      drawMeme(kcal, person, currentResults.label);

      if (toggleStats.checked) addEventToStats(kcal, currentResults.label);
    }

    // Meme
    const memeCanvas = document.getElementById('memeCanvas');
    const ctx = memeCanvas.getContext('2d');

    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      if (w < 2*r) r = w/2;
      if (h < 2*r) r = h/2;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = String(text).split(' ');
      let line = '';
      let yy = y;
      for (let n = 0; n < words.length; n++){
        const testLine = line + words[n] + ' ';
        const testWidth = ctx.measureText(testLine).width;
        if (testWidth > maxWidth && n > 0){
          ctx.fillText(line, x, yy);
          line = words[n] + ' ';
          yy += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, yy);
      return yy;
    }

    function drawMemePlaceholder(){
      ctx.clearRect(0,0,memeCanvas.width,memeCanvas.height);
      const g = ctx.createLinearGradient(0,0,memeCanvas.width,memeCanvas.height);
      g.addColorStop(0, 'rgba(91,124,250,0.45)');
      g.addColorStop(1, 'rgba(255,91,203,0.35)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,memeCanvas.width,memeCanvas.height);

      ctx.fillStyle = 'rgba(5,8,24,0.55)';
      roundRect(ctx, 70, 70, memeCanvas.width-140, memeCanvas.height-140, 34, true, false);

      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.font = '900 56px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillText('LoVasASudar.com', 120, 170);

      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.font = '700 42px system-ui, -apple-system, Segoe UI, Roboto';
      wrapText(ctx,
        currentLang==='en'
          ? 'Pick food + drinks and see how much exercise you need.'
          : 'Elige comida + bebida y mira cu√°nto ejercicio necesitas.',
        120, 245, memeCanvas.width-240, 52);
    }

    function drawMeme(kcal, person, label){
      const kcalR = Math.round(kcal);
      const rows = buildResultsRows(kcal, person);
      const best = rows[0];

      ctx.clearRect(0,0,memeCanvas.width,memeCanvas.height);

      const g = ctx.createLinearGradient(0,0,memeCanvas.width,memeCanvas.height);
      g.addColorStop(0, 'rgba(91,124,250,0.55)');
      g.addColorStop(1, 'rgba(255,91,203,0.45)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,memeCanvas.width,memeCanvas.height);

      ctx.fillStyle = 'rgba(5,8,24,0.55)';
      roundRect(ctx, 70, 70, memeCanvas.width-140, memeCanvas.height-140, 34, true, false);

      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.font = '900 54px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillText('LoVasASudar.com', 120, 160);

      const headline = currentLang==='en'
        ? `You just ‚Äúate‚Äù ${kcalR} kcal`
        : `Te acabas de meter ${kcalR} kcal`;

      ctx.font = '950 74px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillStyle = 'rgba(255,255,255,0.98)';
      wrapText(ctx, headline, 120, 250, memeCanvas.width-240, 78);

      ctx.font = '800 44px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillStyle = 'rgba(255,255,255,0.86)';
      const sub = currentLang==='en'
        ? `That‚Äôs about ${formatMinutes(best.mins)} of ${best.name.toLowerCase()}.`
        : `Eso son ~${formatMinutes(best.mins)} de ${best.name.toLowerCase()}.`;
      wrapText(ctx, sub, 120, 410, memeCanvas.width-240, 52);

      ctx.font = '800 34px system-ui, -apple-system, Segoe UI, Roboto';
      ctx.fillStyle = 'rgba(255,255,255,0.76)';
      const foot = `${label} ¬∑ ${person.name} (${person.weightKg}kg)`;
      wrapText(ctx, foot, 120, 520, memeCanvas.width-240, 44);
    }

    async function canvasToBlob(canvas){
      return new Promise(resolve=> canvas.toBlob(b=>resolve(b), 'image/png'));
    }

    function buildShareText(){
      const kcalR = Math.round(currentResults.kcal||0);
      const person = (currentResults.people && currentResults.people[activePersonIndex]) || { name: (currentLang==='en'?'You':'T√∫'), weightKg: parseNumber(pesoInput.value)||0, sexo: sexoSelect.value||'no' };
      const rows = buildResultsRows(currentResults.kcal||0, person);
      const best = rows[0];

      return currentLang==='en'
        ? `I just ‚Äúate‚Äù ${kcalR} kcal (${currentResults.label}). That‚Äôs ~${formatMinutes(best.mins)} of ${best.name.toLowerCase()}. LoVasASudar.com`
        : `Me acabo de meter ${kcalR} kcal (${currentResults.label}). Eso son ~${formatMinutes(best.mins)} de ${best.name.toLowerCase()}. LoVasASudar.com`;
    }

    // DOM
    const langButtons = document.querySelectorAll('.lang-btn');

    const pesoInput = document.getElementById('peso');
    const sexoSelect = document.getElementById('sexo');

    const foodSelect = document.getElementById('foodSelect');
    const unidadesInput = document.getElementById('unidades');
    const customKcalInp = document.getElementById('customKcal');

    const toggleBattle  = document.getElementById('toggleBattle');
    const toggleDrinks  = document.getElementById('toggleDrinks');
    const toggleInverse = document.getElementById('toggleInverse');
    const toggleStats   = document.getElementById('toggleStats');

    const advancedZone  = document.getElementById('advancedZone');
    const battleDetails = document.getElementById('battleDetails');
    const drinksDetails = document.getElementById('drinksDetails');
    const inverseDetails= document.getElementById('inverseDetails');
    const statsDetails  = document.getElementById('statsDetails');

    const drinkSelect   = document.getElementById('drinkSelect');
    const numCopasInput = document.getElementById('numCopas');

    const btnCalcular   = document.getElementById('btnCalcular');
    const errorBox      = document.getElementById('errorBox');

    const phraseBox     = document.getElementById('phraseBox');
    const kcalBadge     = document.getElementById('kcalBadge');
    const tableWrapper  = document.getElementById('tableWrapper');
    const resultsBody   = document.getElementById('resultsBody');
    const peopleTabs    = document.getElementById('peopleTabs');

    const btnGenMeme    = document.getElementById('btnGenMeme');
    const btnShare      = document.getElementById('btnShare');
    const btnDownload   = document.getElementById('btnDownload');
    const btnCopyText   = document.getElementById('btnCopyText');
    const btnEdit       = document.getElementById('btnEdit');
    const shareStatus   = document.getElementById('shareStatus');

    const disclaimerEl  = document.getElementById('disclaimer');

    // OFF
    const openFoodSearch     = document.getElementById('openFoodSearch');
    const foodSearchPanel    = document.getElementById('foodSearchPanel');
    const btnFoodSearchClose = document.getElementById('btnFoodSearchClose');
    const btnFoodSearch      = document.getElementById('btnFoodSearch');
    const foodQuery          = document.getElementById('foodQuery');
    const foodServing        = document.getElementById('foodServing');
    const foodSearchResults  = document.getElementById('foodSearchResults');
    const foodSearchStatus   = document.getElementById('foodSearchStatus');

    // Inverse
    const invKm        = document.getElementById('invKm');
    const invIntensity = document.getElementById('invIntensity');
    const invDrink     = document.getElementById('invDrink');
    const invExtraMargin = document.getElementById('invExtraMargin');
    const btnInverse   = document.getElementById('btnInverse');
    const inverseOut   = document.getElementById('inverseOut');

    // Battle inputs
    const friend1Name   = document.getElementById('friend1Name');
    const friend1Weight = document.getElementById('friend1Weight');
    const friend2Name   = document.getElementById('friend2Name');
    const friend2Weight = document.getElementById('friend2Weight');
    const friend3Name   = document.getElementById('friend3Name');
    const friend3Weight = document.getElementById('friend3Weight');

    // Stats
    const weekKcalEl    = document.getElementById('weekKcal');
    const weekKmEl      = document.getElementById('weekKm');
    const yearTopEl     = document.getElementById('yearTop');
    const btnResetStats = document.getElementById('btnResetStats');
    const btnShareStats = document.getElementById('btnShareStats');
    const statsHeadline = document.getElementById('statsHeadline');

    function setAdvancedVisibility(){
      const any = toggleBattle.checked || toggleDrinks.checked || toggleInverse.checked || toggleStats.checked;
      advancedZone.classList.toggle('show', any);

      battleDetails.open  = toggleBattle.checked;
      drinksDetails.open  = toggleDrinks.checked;
      inverseDetails.open = toggleInverse.checked;
      statsDetails.open   = toggleStats.checked;

      battleDetails.style.display  = toggleBattle.checked  ? 'block' : 'none';
      drinksDetails.style.display  = toggleDrinks.checked  ? 'block' : 'none';
      inverseDetails.style.display = toggleInverse.checked ? 'block' : 'none';
      statsDetails.style.display   = toggleStats.checked   ? 'block' : 'none';
    }

    [toggleBattle, toggleDrinks, toggleInverse, toggleStats].forEach(t=>{
      t.addEventListener('change', ()=>{
        setAdvancedVisibility();
        gaEvent('toggle_feature', { feature: t.id, on: t.checked ? 1 : 0 });
      });
    });

    langButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        currentLang = btn.dataset.lang || 'es';
        applyI18n();
        gaEvent('lang_change', { lang: currentLang });
      });
    });

    btnEdit.addEventListener('click', ()=>{
      window.scrollTo({ top: 0, behavior: 'smooth' });
      gaEvent('edit_clicked', {});
    });

    openFoodSearch.addEventListener('click', ()=>{
      foodSearchPanel.style.display = 'block';
      gaEvent('open_foodfacts_panel', {});
    });
    btnFoodSearchClose.addEventListener('click', ()=>{
      foodSearchPanel.style.display = 'none';
      gaEvent('close_foodfacts_panel', {});
    });

    function renderOffResults(items){
      foodSearchResults.innerHTML = '';
      items.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'result-item';

        const left = document.createElement('div');
        const title = document.createElement('div');
        title.style.fontWeight = '950';
        title.textContent = item.name || '‚Äî';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `${item.brand ? `<b>${item.brand}</b> ¬∑ ` : ''}${item.kcal100 ? `${item.kcal100} kcal/100g` : 'kcal n/d'}`;

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.gap = '8px';
        right.style.alignItems = 'flex-end';

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-primary';
        addBtn.textContent = currentLang === 'en' ? 'Add' : 'A√±adir';

        addBtn.addEventListener('click', ()=>{
          const s = parseNumber(foodServing.value);
          let kcal = item.kcal100 || 0;
          let label = item.name || 'Producto';

          if (Number.isFinite(s) && s > 0 && item.kcal100){
            kcal = (item.kcal100 * s) / 100;
            label = `${label} (${Math.round(s)}g)`;
          } else if (!item.kcal100){
            toast(foodSearchStatus, tMsg('offEmpty'));
            return;
          }

          const opt = document.createElement('option');
          opt.value = String(Math.round(kcal));
          opt.textContent = `${label} (~${Math.round(kcal)} kcal)`;
          opt.setAttribute('data-label', label);

          foodSelect.insertBefore(opt, foodSelect.options[1] || null);
          foodSelect.value = opt.value;

          const picked = getPickedFoods();
          picked.unshift({ value: opt.value, label, text: opt.textContent });
          savePickedFoods(picked);

          foodSearchPanel.style.display = 'none';
          gaEvent('off_add_item', { kcal: Math.round(kcal), hasServing: (Number.isFinite(s) && s>0) ? 1 : 0 });
        });

        right.appendChild(addBtn);
        div.appendChild(left);
        div.appendChild(right);
        foodSearchResults.appendChild(div);
      });

      foodSearchResults.style.display = 'block';
    }

    async function searchOpenFoodFacts(q){
      const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=${encodeURIComponent(q)}&search_simple=1&action=process&json=1&page_size=8`;
      const res = await fetch(url);
      const data = await res.json();
      const prods = (data && data.products) ? data.products : [];
      const items = prods.map(p=>{
        const name = (p.product_name || p.generic_name || '').trim();
        const brand = (p.brands || '').split(',')[0].trim();
        const kcal100 = p.nutriments && (p.nutriments['energy-kcal_100g'] || p.nutriments['energy-kcal_serving']);
        const kcalNum = Number(kcal100);
        return {
          name: name || (brand ? `${brand} (producto)` : 'Producto'),
          brand: brand || '',
          kcal100: Number.isFinite(kcalNum)
        ? Math.round(kcalNum)
        : null;
      }).filter(x => x && x.name);

      return items;
    }

    btnFoodSearch.addEventListener('click', async ()=>{
      const q = (foodQuery.value || '').trim();
      if (!q) return;
      foodSearchStatus.style.display = 'none';
      foodSearchResults.style.display = 'none';

      btnFoodSearch.disabled = true;
      btnFoodSearch.style.opacity = '0.7';
      gaEvent('off_search', { q: q.slice(0, 80) });

      try{
        const items = await searchOpenFoodFacts(q);
        if (!items.length){
          toast(foodSearchStatus, currentLang === 'en' ? 'No results.' : 'Sin resultados.');
        } else {
          renderOffResults(items);
        }
      } catch(e){
        toast(foodSearchStatus, currentLang === 'en' ? 'Search failed.' : 'Fall√≥ la b√∫squeda.');
      } finally {
        btnFoodSearch.disabled = false;
        btnFoodSearch.style.opacity = '1';
      }
    });

    // Enter para buscar en OFF
    foodQuery.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        btnFoodSearch.click();
      }
    });

    // --- Calcular principal ---
    btnCalcular.addEventListener('click', ()=>{
      clearError();

      const main = computeTotalKcal();
      if (!main) return;

      const people = getBattlePeopleOrSolo(main);
      currentResults.people = people;
      currentResults.kcal = main.totalKcal;
      currentResults.label = main.label;

      activePersonIndex = 0;

      renderPeopleTabs();
      renderResultsForPerson(0);

      // UX: baja a resultados
      document.getElementById('resultsSection').scrollIntoView({ behavior:'smooth', block:'start' });

      gaEvent('calculate_click', {
        kcal: Math.round(main.totalKcal),
        battle: toggleBattle.checked ? 1 : 0,
        drinks: toggleDrinks.checked ? 1 : 0,
        inverse: toggleInverse.checked ? 1 : 0,
        stats: toggleStats.checked ? 1 : 0
      });

      // Guardar "favoritos" locales (lo elegido)
      try{
        const picked = getPickedFoods();
        const label = main.label;
        // evita duplicados por label
        const next = [{ value: String(Math.round(main.totalKcal)), label, text: `${label} (~${Math.round(main.totalKcal)} kcal)` }]
          .concat(picked.filter(p => p && p.label !== label));
        savePickedFoods(next);
      }catch(e){}
    });

    // --- Bot√≥n Generar meme ---
    btnGenMeme.addEventListener('click', ()=>{
      if (!(currentResults && currentResults.kcal > 0)){
        showError(tMsg('memeNeedCalc'));
        return;
      }
      const person = (currentResults.people && currentResults.people[activePersonIndex]) || { name:(currentLang==='en'?'You':'T√∫'), weightKg: parseNumber(pesoInput.value)||75, sexo: sexoSelect.value||'no' };
      drawMeme(currentResults.kcal, person, currentResults.label || (currentLang==='en'?'your choice':'tu elecci√≥n'));
      gaEvent('meme_generate_click', {});
    });

    // --- Compartir ---
    btnShare.addEventListener('click', async ()=>{
      if (!(currentResults && currentResults.kcal > 0)){
        showError(tMsg('memeNeedCalc'));
        return;
      }
      const text = buildShareText();
      try{
        const blob = await canvasToBlob(memeCanvas);
        const file = new File([blob], 'lovasasudar.png', { type: 'image/png' });

        // Share API con archivo (m√≥vil suele ir mejor)
        if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
          await navigator.share({ files:[file], text, title: 'LoVasASudar.com' });
          toast(shareStatus, currentLang==='en' ? 'Shared ‚úÖ' : 'Compartido ‚úÖ');
          gaEvent('meme_share_done', { mode:'files' });
          return;
        }

        // Fallback: compartir solo texto
        if (navigator.share){
          await navigator.share({ text, title: 'LoVasASudar.com' });
          toast(shareStatus, currentLang==='en' ? 'Shared ‚úÖ' : 'Compartido ‚úÖ');
          gaEvent('meme_share_done', { mode:'text' });
          return;
        }

        // √öltimo fallback
        toast(shareStatus, tMsg('shareFail'));
        gaEvent('meme_share_fail', { reason:'no_share_api' });
      } catch(e){
        toast(shareStatus, tMsg('shareFail'));
        gaEvent('meme_share_fail', { reason:'exception' });
      }
    });

    // --- Descargar imagen ---
    btnDownload.addEventListener('click', async ()=>{
      try{
        const a = document.createElement('a');
        a.download = 'lovasasudar.png';
        a.href = memeCanvas.toDataURL('image/png');
        document.body.appendChild(a);
        a.click();
        a.remove();
        gaEvent('meme_download', {});
      } catch(e){}
    });

    // --- Copiar texto ---
    btnCopyText.addEventListener('click', async ()=>{
      try{
        const text = buildShareText();
        await navigator.clipboard.writeText(text);
        toast(shareStatus, tMsg('copied'));
        gaEvent('copy_text', {});
      } catch(e){
        // fallback: prompt
        const text = buildShareText();
        window.prompt(currentLang==='en' ? 'Copy:' : 'Copia:', text);
        gaEvent('copy_text_fallback', {});
      }
    });

    // --- Inversa ---
    btnInverse.addEventListener('click', ()=>{
      clearError();
      const w = parseNumber(pesoInput.value);
      if (!Number.isFinite(w) || w < 30 || w > 250) { showError(tMsg('errorInverseNeedWeight')); return; }

      const km = parseNumber(invKm.value);
      if (!Number.isFinite(km) || km <= 0) { showError(tMsg('errorInverseKm')); return; }

      const intensity = parseNumber(invIntensity.value) || 1.0;
      const margin = parseNumber(invExtraMargin.value) || 0.70;

      const chosen = invDrink.value;
      let kcalPerUnit = 0;
      if (chosen === 'custom' || chosen === '0') kcalPerUnit = 0;
      else kcalPerUnit = parseNumber(chosen) || 0;

      // regla r√°pida: running ~1 kcal/kg/km
      const burnt = w * km * intensity;
      const allowed = burnt * margin;

      let units = (kcalPerUnit > 0) ? (allowed / kcalPerUnit) : null;

      inverseOut.style.display = 'block';
      inverseOut.innerHTML = `
        <div style="font-weight:950; font-size:1.1rem;">${currentLang==='en' ? 'Inverse result' : 'Resultado inverso'}</div>
        <div class="muted" style="margin-top:6px;">
          ${currentLang==='en'
            ? `If you run <b>${km}</b> km at <b>${intensity.toFixed(2)}</b> intensity, you burn ~<b>${Math.round(burnt)}</b> kcal. With margin <b>${Math.round(margin*100)}%</b>, your ‚Äúbudget‚Äù is ~<b>${Math.round(allowed)}</b> kcal.`
            : `Si corres <b>${km}</b> km con intensidad <b>${intensity.toFixed(2)}</b>, quemas ~<b>${Math.round(burnt)}</b> kcal. Con margen <b>${Math.round(margin*100)}%</b>, tu ‚Äúpresupuesto‚Äù es ~<b>${Math.round(allowed)}</b> kcal.`
          }
        </div>
        <div style="margin-top:10px; font-weight:950;">
          ${kcalPerUnit > 0
            ? (currentLang==='en'
              ? `That‚Äôs about <b>${units.toFixed(1)}</b> units of your choice.`
              : `Eso son aproximadamente <b>${units.toFixed(1)}</b> unidades de tu elecci√≥n.`)
            : (currentLang==='en'
              ? `Pick a food/drink with known kcal per unit to get a unit estimate.`
              : `Elige una comida/bebida con kcal por unidad para estimar unidades.`)
          }
        </div>
      `;

      gaEvent('inverse_calculate', { km, burnt: Math.round(burnt), allowed: Math.round(allowed) });
    });

    // --- Stats UI ---
    function renderStatsUI(){
      if (!weekKcalEl || !weekKmEl || !yearTopEl) return;

      const last7 = getEventsLastDays(7);
      const sum7 = sumKcal(last7);

      // km aproximados usando regla running 1 kcal/kg/km con peso actual si lo hay
      const w = parseNumber(pesoInput.value);
      const weightForKm = (Number.isFinite(w) && w>0) ? w : 75;
      const km7 = sum7 / weightForKm;

      weekKcalEl.textContent = String(Math.round(sum7));
      weekKmEl.textContent = (km7 > 0 ? km7.toFixed(1) : '0');

      const yr = thisYear();
      const yEvents = getYearEvents(yr);
      const top = getTopEvent(yEvents);
      yearTopEl.textContent = top
        ? `${top.label} ¬∑ ${Math.round(top.kcal)} kcal`
        : (currentLang==='en' ? '‚Äî' : '‚Äî');
    }

    btnResetStats.addEventListener('click', ()=>{
      localStorage.removeItem(LS_STATS_KEY);
      renderStatsUI();
      toast(statsHeadline, currentLang==='en' ? 'Reset ‚úÖ' : 'Reset ‚úÖ');
      gaEvent('stats_reset', {});
    });

    btnShareStats.addEventListener('click', async ()=>{
      const last7 = getEventsLastDays(7);
      const sum7 = sumKcal(last7);
      const yr = thisYear();
      const top = getTopEvent(getYearEvents(yr));

      const text = currentLang==='en'
        ? `My weekly ‚Äúpunishment‚Äù: ${Math.round(sum7)} kcal (last 7 days). Top this year: ${top ? `${top.label} (${Math.round(top.kcal)} kcal)` : '‚Äî'}. LoVasASudar.com`
        : `Mi ‚Äúcastigo‚Äù semanal: ${Math.round(sum7)} kcal (√∫ltimos 7 d√≠as). Top este a√±o: ${top ? `${top.label} (${Math.round(top.kcal)} kcal)` : '‚Äî'}. LoVasASudar.com`;

      try{
        await navigator.clipboard.writeText(text);
        toast(statsHeadline, tMsg('copied'));
        gaEvent('stats_share_copy', {});
      } catch(e){
        window.prompt(currentLang==='en' ? 'Copy:' : 'Copia:', text);
        gaEvent('stats_share_copy_fallback', {});
      }
    });

    // --- UX: cuando abres/cierra details a mano, sincroniza checkboxes ---
    function syncToggleFromDetails(detailsEl, toggleEl){
      if (!detailsEl || !toggleEl) return;
      detailsEl.addEventListener('toggle', ()=>{
        toggleEl.checked = detailsEl.open;
        setAdvancedVisibility();
      });
    }
    syncToggleFromDetails(battleDetails, toggleBattle);
    syncToggleFromDetails(drinksDetails, toggleDrinks);
    syncToggleFromDetails(inverseDetails, toggleInverse);
    syncToggleFromDetails(statsDetails, toggleStats);

    // --- Init ---
    function restorePickedFoods(){
      const picked = getPickedFoods();
      if (!picked.length) return;
      // Inserta algunos recientes en el select (sin duplicar)
      const existingLabels = new Set(Array.from(foodSelect.options).map(o => o.getAttribute('data-label') || o.textContent));
      let inserted = 0;
      for (const p of picked){
        if (!p || !p.text) continue;
        if (existingLabels.has(p.label)) continue;
        const opt = document.createElement('option');
        opt.value = String(p.value || 0);
        opt.textContent = p.text;
        opt.setAttribute('data-label', p.label || p.text);
        foodSelect.insertBefore(opt, foodSelect.options[1] || null);
        inserted++;
        if (inserted >= 6) break;
      }
    }

    function init(){
      // disclaimer
      disclaimerEl.innerHTML = I18N[currentLang].disclaimer || '';
      // placeholder meme
      drawMemePlaceholder();
      // stats
      renderStatsUI();
      // advanced zone
      setAdvancedVisibility();
      // restore picks
      restorePickedFoods();
      // i18n
      applyI18n();

      gaEvent('session_start', { v: 'single_html_v2' });
    }

    init();
  </script>

</body>
</html>
